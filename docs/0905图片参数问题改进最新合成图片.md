# ç°æœ‰åˆæˆå›¾ç‰‡ä¸Imagen 3æ ¼å¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

### å½“å‰çŠ¶å†µ

1. **Imagen 3ç›´æ¥ç”Ÿæˆ**ï¼šå›¾ç‰‡æ ¼å¼æ­£ç¡®ï¼Œä½†å†…å®¹æ˜¯è™šæ„çš„ï¼Œä¸åŒ…å«ç”¨æˆ·çœŸå®åˆå½±
2. **ç°æœ‰åˆæˆå›¾ç‰‡**ï¼šå†…å®¹æ­£ç¡®ï¼ˆåŒ…å«ç”¨æˆ·å’ŒDoroçš„çœŸå®åˆå½±ï¼‰ï¼Œä½†æ ¼å¼ä¸Imagen 3ä¸ä¸€è‡´
3. **æ ¼å¼å·®å¼‚**ï¼šéœ€è¦è®©ç°æœ‰åˆæˆå›¾ç‰‡å½¢æˆä¸Imagen 3ä¸€è‡´çš„æ ¼å¼ï¼Œä»¥ä¾¿ç»Ÿä¸€ä¼ é€’ç»™è§†é¢‘ç”Ÿæˆ

### æ ¸å¿ƒç›®æ ‡

å°†ç°æœ‰çš„Doroåˆæˆå›¾ç‰‡è½¬æ¢ä¸ºä¸Imagen 3 APIè¿”å›å¯¹è±¡ç›¸åŒçš„æ ¼å¼ï¼Œå®ç°ç»Ÿä¸€çš„è§†é¢‘ç”Ÿæˆæ¥å£è°ƒç”¨ã€‚

## æŠ€æœ¯åˆ†æ

### Imagen 3 APIè¿”å›æ ¼å¼

```python
# Imagen 3 APIè°ƒç”¨
imagen_response = client.models.generate_images(
    model="imagen-3.0-generate-002",
    prompt=image_prompt,
)

# è¿”å›çš„å›¾ç‰‡å¯¹è±¡æ ¼å¼
generated_image = imagen_response.generated_images[0].image
# è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å›¾ç‰‡å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥ä¼ é€’ç»™Veo 3
```

### ç°æœ‰åˆæˆå›¾ç‰‡æ ¼å¼

```python
# å½“å‰generate_doro_selfie_with_attractionè¿”å›æ ¼å¼
return True, "Doroåˆå½±ç”ŸæˆæˆåŠŸï¼", {
    "image_url": f"data:image/png;base64,{img_base64}",  # base64å­—ç¬¦ä¸²
    "filename": filename,
    "filepath": filepath,  # æ–‡ä»¶è·¯å¾„
    "prompt_used": main_prompt,
    "attraction_name": attraction_info.get("name"),
    "timestamp": timestamp
}
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæ¨¡æ‹ŸImagen 3å¯¹è±¡ç»“æ„ï¼ˆæ¨èï¼‰

åˆ›å»ºä¸€ä¸ªåŒ…è£…å™¨ç±»ï¼Œè®©ç°æœ‰åˆæˆå›¾ç‰‡å…·æœ‰ä¸Imagen 3ç›¸åŒçš„æ¥å£ï¼š

```python
class ImagenCompatibleImage:
    """
    æ¨¡æ‹ŸImagen 3è¿”å›çš„å›¾ç‰‡å¯¹è±¡ç»“æ„
    ä½¿ç°æœ‰åˆæˆå›¾ç‰‡ä¸Imagen 3æ ¼å¼å…¼å®¹
    """
    
    def __init__(self, pil_image: Image.Image, filepath: str = None):
        self._pil_image = pil_image
        self._filepath = filepath
        self._data = None
    
    @property
    def data(self):
        """è¿”å›å›¾ç‰‡çš„å­—èŠ‚æ•°æ®"""
        if self._data is None:
            if self._filepath and os.path.exists(self._filepath):
                # ä»æ–‡ä»¶è¯»å–
                with open(self._filepath, 'rb') as f:
                    self._data = f.read()
            else:
                # ä»PILå¯¹è±¡ç”Ÿæˆ
                buffer = BytesIO()
                self._pil_image.save(buffer, format='PNG')
                self._data = buffer.getvalue()
        return self._data
    
    def save(self, filepath: str):
        """ä¿å­˜å›¾ç‰‡åˆ°æŒ‡å®šè·¯å¾„"""
        if self._pil_image:
            self._pil_image.save(filepath, 'PNG')
        elif self._filepath:
            # å¤åˆ¶ç°æœ‰æ–‡ä»¶
            import shutil
            shutil.copy2(self._filepath, filepath)
    
    @property
    def size(self):
        """è¿”å›å›¾ç‰‡å°ºå¯¸"""
        return self._pil_image.size if self._pil_image else None
    
    def __getattr__(self, name):
        """ä»£ç†åˆ°PIL Imageå¯¹è±¡"""
        if self._pil_image and hasattr(self._pil_image, name):
            return getattr(self._pil_image, name)
        raise AttributeError(f"'{self.__class__.__name__}' object has no attribute '{name}'")
```

### æ–¹æ¡ˆäºŒï¼šç›´æ¥ä½¿ç”¨PIL Imageå¯¹è±¡

åŸºäºæµ‹è¯•å‘ç°ï¼ŒVeo 3 APIä¹Ÿæ¥å—æ ‡å‡†çš„PIL Imageå¯¹è±¡ï¼š

```python
def convert_existing_image_to_imagen_format(image_result: Dict) -> Image.Image:
    """
    å°†ç°æœ‰åˆæˆå›¾ç‰‡è½¬æ¢ä¸ºä¸Imagen 3å…¼å®¹çš„æ ¼å¼
    
    Args:
        image_result: generate_doro_selfie_with_attractionè¿”å›çš„ç»“æœ
        
    Returns:
        PIL Imageå¯¹è±¡ï¼Œå¯ç›´æ¥ä¼ é€’ç»™Veo 3
    """
    try:
        # æ–¹æ³•1ï¼šä»æ–‡ä»¶è·¯å¾„åŠ è½½ï¼ˆæ¨èï¼‰
        if 'filepath' in image_result and os.path.exists(image_result['filepath']):
            logger.info(f"ğŸ“ ä»æ–‡ä»¶åŠ è½½å›¾ç‰‡: {image_result['filepath']}")
            return Image.open(image_result['filepath'])
        
        # æ–¹æ³•2ï¼šä»base64æ•°æ®åŠ è½½
        elif 'image_url' in image_result:
            logger.info("ğŸ“¦ ä»base64æ•°æ®åŠ è½½å›¾ç‰‡")
            base64_data = image_result['image_url'].split(',')[1]
            image_data = base64.b64decode(base64_data)
            return Image.open(BytesIO(image_data))
        
        else:
            raise ValueError("æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®")
            
    except Exception as e:
        logger.error(f"âŒ è½¬æ¢å›¾ç‰‡æ ¼å¼å¤±è´¥: {e}")
        raise
```

### æ–¹æ¡ˆä¸‰ï¼šç»Ÿä¸€çš„å›¾ç‰‡å¯¹è±¡å·¥å‚

```python
class UnifiedImageFactory:
    """ç»Ÿä¸€çš„å›¾ç‰‡å¯¹è±¡å·¥å‚ï¼Œå¤„ç†ä¸åŒæ¥æºçš„å›¾ç‰‡"""
    
    @staticmethod
    def create_from_imagen(imagen_response) -> 'UnifiedImage':
        """ä»Imagen 3å“åº”åˆ›å»ºç»Ÿä¸€å›¾ç‰‡å¯¹è±¡"""
        return UnifiedImage(
            source_type='imagen',
            image_object=imagen_response.generated_images[0].image
        )
    
    @staticmethod
    def create_from_existing(image_result: Dict) -> 'UnifiedImage':
        """ä»ç°æœ‰åˆæˆå›¾ç‰‡åˆ›å»ºç»Ÿä¸€å›¾ç‰‡å¯¹è±¡"""
        # åŠ è½½PILå›¾ç‰‡
        if 'filepath' in image_result and os.path.exists(image_result['filepath']):
            pil_image = Image.open(image_result['filepath'])
        else:
            base64_data = image_result['image_url'].split(',')[1]
            image_data = base64.b64decode(base64_data)
            pil_image = Image.open(BytesIO(image_data))
        
        return UnifiedImage(
            source_type='existing',
            image_object=pil_image,
            metadata=image_result
        )

class UnifiedImage:
    """ç»Ÿä¸€çš„å›¾ç‰‡å¯¹è±¡ï¼Œå…¼å®¹Veo 3 API"""
    
    def __init__(self, source_type: str, image_object, metadata: Dict = None):
        self.source_type = source_type
        self.image_object = image_object
        self.metadata = metadata or {}
    
    def get_veo_compatible_object(self):
        """è¿”å›ä¸Veo 3å…¼å®¹çš„å›¾ç‰‡å¯¹è±¡"""
        if self.source_type == 'imagen':
            # Imagen 3çš„åŸå§‹å¯¹è±¡å¯ä»¥ç›´æ¥ä½¿ç”¨
            return self.image_object
        elif self.source_type == 'existing':
            # PIL Imageå¯¹è±¡ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨
            return self.image_object
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„å›¾ç‰‡ç±»å‹: {self.source_type}")
```

## å®æ–½æ–¹æ¡ˆ

### ä¿®æ”¹generate_doro_video_with_attractionæ–¹æ³•

```python
async def generate_doro_video_with_attraction(
    self,
    user_photo: UploadFile,
    doro_photo: UploadFile,
    style_photo: Optional[UploadFile],
    attraction_info: Dict
) -> Tuple[bool, str, Optional[Dict]]:
    """
    ç”ŸæˆåŒ…å«æ™¯ç‚¹èƒŒæ™¯çš„Doroåˆå½±è§†é¢‘
    ä½¿ç”¨ç»Ÿä¸€çš„å›¾ç‰‡æ ¼å¼å¤„ç†ç­–ç•¥
    """
    try:
        logger.info(f"å¼€å§‹ç”ŸæˆDoroåˆå½±è§†é¢‘: æ™¯ç‚¹={attraction_info.get('name', 'Unknown')}")
        
        client = genai_client.Client()
        
        # ç¬¬ä¸€æ­¥ï¼šå°è¯•ä½¿ç”¨Imagen 3ç”Ÿæˆï¼ˆä¸»è·¯å¾„ï¼‰
        try:
            logger.info("ğŸ¨ ä¸»è·¯å¾„ï¼šä½¿ç”¨Imagen 3ç”Ÿæˆé™æ€å›¾ç‰‡...")
            
            # ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
            image_prompt = self._generate_image_prompt_for_video(
                user_photo, doro_photo, attraction_info, style_photo
            )
            
            # ä½¿ç”¨Imagen 3ç”Ÿæˆ
            imagen_response = client.models.generate_images(
                model="imagen-3.0-generate-002",
                prompt=image_prompt,
            )
            
            if not imagen_response.generated_images:
                raise Exception("Imagenæœªç”Ÿæˆå›¾ç‰‡")
            
            # ç›´æ¥ä½¿ç”¨Imagenè¿”å›çš„åŸå§‹å›¾ç‰‡å¯¹è±¡
            generated_image = imagen_response.generated_images[0].image
            logger.info("âœ… Imagen 3é™æ€å›¾ç‰‡ç”ŸæˆæˆåŠŸ")
            
            # ä¿å­˜ä¸€ä»½åˆ°ç£ç›˜ç”¨äºå±•ç¤º
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            safe_name = "".join(c for c in attraction_info.get('name', 'unknown') if c.isalnum() or c in ('_', '-'))[:30]
            imagen_filename = f"imagen_{safe_name}_{timestamp}.png"
            imagen_filepath = os.path.join(self.output_dir, imagen_filename)
            
            # ä¿å­˜å›¾ç‰‡
            if hasattr(generated_image, 'save'):
                generated_image.save(imagen_filepath)
            elif hasattr(generated_image, 'data'):
                with open(imagen_filepath, 'wb') as f:
                    f.write(generated_image.data)
            
            # åˆ›å»ºè¿”å›æ•°æ®
            with open(imagen_filepath, 'rb') as f:
                img_data = f.read()
            img_base64 = base64.b64encode(img_data).decode()
            
            image_result = {
                'image_url': f"data:image/png;base64,{img_base64}",
                'filename': imagen_filename,
                'filepath': imagen_filepath,
                'source': 'imagen3'
            }
            
        except Exception as e:
            logger.error(f"âŒ Imagenç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é™çº§è·¯å¾„: {e}")
            
            # é™çº§è·¯å¾„ï¼šä½¿ç”¨ç°æœ‰åˆå½±ç”Ÿæˆ
            logger.info("ğŸ“¸ é™çº§è·¯å¾„ï¼šä½¿ç”¨ç°æœ‰Doroåˆå½±ç”Ÿæˆ...")
            success, message, image_result = await self.generate_doro_selfie_with_attraction(
                user_photo=user_photo,
                doro_photo=doro_photo,
                style_photo=style_photo,
                attraction_info=attraction_info
            )
            
            if not success:
                return False, f"å›¾ç‰‡ç”Ÿæˆå¤±è´¥: {message}", None
            
            # è½¬æ¢ç°æœ‰åˆæˆå›¾ç‰‡ä¸ºImagenå…¼å®¹æ ¼å¼
            generated_image = self._convert_existing_to_imagen_format(image_result)
            image_result['source'] = 'existing_converted'
        
        # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ç»Ÿä¸€æ ¼å¼çš„å›¾ç‰‡ç”Ÿæˆè§†é¢‘
        logger.info("ğŸ¬ ç¬¬äºŒæ­¥ï¼šä½¿ç”¨Veo 3ç”ŸæˆåŠ¨æ€è§†é¢‘...")
        
        # ç”Ÿæˆè§†é¢‘æç¤ºè¯
        video_prompt = self._generate_video_prompt_from_image_prompt(
            image_result.get('prompt_used', ''),
            attraction_info
        )
        logger.info(f"ğŸ¬ è§†é¢‘æç¤ºè¯: {video_prompt[:200]}...")
        
        # è°ƒç”¨Veo 3ç”Ÿæˆè§†é¢‘ - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼çš„å›¾ç‰‡å¯¹è±¡
        from google.genai import types
        operation = client.models.generate_videos(
            model="veo-3.0-generate-preview",
            prompt=video_prompt,
            image=generated_image,  # ç»Ÿä¸€æ ¼å¼çš„å›¾ç‰‡å¯¹è±¡
            config=types.GenerateVideosConfig(
                aspect_ratio="16:9",
            ),
        )
        
        # åç»­è§†é¢‘å¤„ç†é€»è¾‘ä¿æŒä¸å˜...
        
    except Exception as e:
        logger.error(f"ç”ŸæˆDoroåˆå½±è§†é¢‘æ—¶å‡ºé”™: {str(e)}")
        return False, f"è§†é¢‘ç”Ÿæˆå¤±è´¥: {str(e)}", None

def _convert_existing_to_imagen_format(self, image_result: Dict):
    """
    å°†ç°æœ‰åˆæˆå›¾ç‰‡è½¬æ¢ä¸ºä¸Imagen 3å…¼å®¹çš„æ ¼å¼
    
    Args:
        image_result: generate_doro_selfie_with_attractionè¿”å›çš„ç»“æœ
        
    Returns:
        ä¸Imagen 3å…¼å®¹çš„å›¾ç‰‡å¯¹è±¡
    """
    try:
        # ä¼˜å…ˆä»æ–‡ä»¶è·¯å¾„åŠ è½½ï¼ˆæœ€å¯é ï¼‰
        if 'filepath' in image_result and os.path.exists(image_result['filepath']):
            logger.info(f"ğŸ“ ä»æ–‡ä»¶åŠ è½½ç°æœ‰åˆæˆå›¾ç‰‡: {image_result['filepath']}")
            return Image.open(image_result['filepath'])
        
        # å¤‡é€‰ï¼šä»base64æ•°æ®åŠ è½½
        elif 'image_url' in image_result:
            logger.info("ğŸ“¦ ä»base64æ•°æ®åŠ è½½ç°æœ‰åˆæˆå›¾ç‰‡")
            base64_data = image_result['image_url'].split(',')[1]
            image_data = base64.b64decode(base64_data)
            return Image.open(BytesIO(image_data))
        
        else:
            raise ValueError("æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®")
            
    except Exception as e:
        logger.error(f"âŒ è½¬æ¢ç°æœ‰å›¾ç‰‡æ ¼å¼å¤±è´¥: {e}")
        raise Exception(f"å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥: {e}")
```

## å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. æ ¼å¼å…¼å®¹æ€§

- **Imagen 3å¯¹è±¡**ï¼š`imagen_response.generated_images[0].image`
- **PIL Imageå¯¹è±¡**ï¼š`Image.open(filepath)` æˆ– `Image.open(BytesIO(data))`
- **Veo 3å…¼å®¹æ€§**ï¼šä¸¤ç§æ ¼å¼éƒ½å¯ä»¥ç›´æ¥ä¼ é€’ç»™`generate_videos`

### 2. æ•°æ®æµä¼˜åŒ–

```
ç°æœ‰åˆæˆå›¾ç‰‡ â†’ PIL Imageå¯¹è±¡ â†’ Veo 3è§†é¢‘ç”Ÿæˆ
Imagen 3ç”Ÿæˆ â†’ åŸå§‹å¯¹è±¡ â†’ Veo 3è§†é¢‘ç”Ÿæˆ
```

### 3. ç»Ÿä¸€æ¥å£

```python
# æ— è®ºæ¥æºå¦‚ä½•ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„è°ƒç”¨æ–¹å¼
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=generated_image,  # ç»Ÿä¸€çš„å›¾ç‰‡å¯¹è±¡
    config=types.GenerateVideosConfig(aspect_ratio="16:9"),
)
```

## é¢„æœŸæ•ˆæœ

### 1. å†…å®¹å‡†ç¡®æ€§

- ä½¿ç”¨ç°æœ‰åˆæˆå›¾ç‰‡ç¡®ä¿åŒ…å«çœŸå®çš„ç”¨æˆ·å’ŒDoroåˆå½±
- é¿å…Imagen 3ç”Ÿæˆè™šæ„å†…å®¹çš„é—®é¢˜

### 2. æ ¼å¼å…¼å®¹æ€§

- ç°æœ‰åˆæˆå›¾ç‰‡è½¬æ¢ä¸ºPIL Imageå¯¹è±¡
- ä¸Imagen 3å¯¹è±¡å…·æœ‰ç›¸åŒçš„APIå…¼å®¹æ€§

### 3. æ€§èƒ½ä¼˜åŒ–

- å‡å°‘ä¸å¿…è¦çš„æ ¼å¼è½¬æ¢
- ç›´æ¥ä½¿ç”¨æ–‡ä»¶è·¯å¾„åŠ è½½ï¼Œé¿å…base64ç¼–è§£ç 

### 4. å®¹é”™æœºåˆ¶

- ä¸»è·¯å¾„ï¼šImagen 3ï¼ˆå¦‚æœéœ€è¦è™šæ„å†…å®¹ï¼‰
- é™çº§è·¯å¾„ï¼šç°æœ‰åˆæˆå›¾ç‰‡è½¬æ¢ï¼ˆç¡®ä¿çœŸå®å†…å®¹ï¼‰

## å®æ–½æ­¥éª¤

1. **æ·»åŠ è½¬æ¢æ–¹æ³•**ï¼š`_convert_existing_to_imagen_format`
2. **ä¿®æ”¹è§†é¢‘ç”Ÿæˆé€»è¾‘**ï¼šä½¿ç”¨ç»Ÿä¸€çš„å›¾ç‰‡å¯¹è±¡å¤„ç†
3. **æµ‹è¯•å…¼å®¹æ€§**ï¼šéªŒè¯PIL Imageå¯¹è±¡ä¸Veo 3çš„å…¼å®¹æ€§
4. **ä¼˜åŒ–é”™è¯¯å¤„ç†**ï¼šç¡®ä¿æ ¼å¼è½¬æ¢çš„ç¨³å®šæ€§

## ğŸš¨ PydanticéªŒè¯é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ¡ˆ

### æœ€æ–°å‘ç°çš„é—®é¢˜

åœ¨å®é™…æµ‹è¯•ä¸­å‘ç°ï¼Œç›´æ¥ä½¿ç”¨å­—å…¸æ ¼å¼ä¼šå¯¼è‡´PydanticéªŒè¯é”™è¯¯ï¼š

```
1 validation error for _GenerateVideosParameters
image.bytesBase64Encoded
  Extra inputs are not permitted [type=extra_forbidden, input_value='iVBORw0KGgoAAAANSUhEUgAA...', input_type=str]
```

### é—®é¢˜æ ¹æœ¬åŸå› 

1. **å­—å…¸æ ¼å¼è¢«æ‹’ç»**ï¼šç›´æ¥ä¼ é€’`{"bytesBase64Encoded": ..., "mimeType": ...}`å­—å…¸è¢«PydanticéªŒè¯å™¨æ‹’ç»
2. **APIæœŸæœ›ç‰¹å®šå¯¹è±¡ç±»å‹**ï¼šVeo 3 APIæœŸæœ›çš„æ˜¯ç‰¹å®šçš„å¯¹è±¡ç±»å‹ï¼Œè€Œä¸æ˜¯æ™®é€šå­—å…¸
3. **SDKå°è£…è¦æ±‚**ï¼šgoogle-genai SDKå¯¹å‚æ•°è¿›è¡Œäº†ä¸¥æ ¼çš„ç±»å‹éªŒè¯

### æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨types.Part.from_dict()

åŸºäºæˆåŠŸæ¡ˆä¾‹åˆ†æï¼Œæ­£ç¡®çš„æ–¹æ³•æ˜¯ä½¿ç”¨SDKæä¾›çš„`types.Part.from_dict()`æ–¹æ³•ï¼š

```python
def _convert_existing_to_imagen_format(self, image_result: Dict):
    """
    å°†ç°æœ‰åˆæˆå›¾ç‰‡è½¬æ¢ä¸ºVeo 3 APIå…¼å®¹çš„æ ¼å¼
    ä½¿ç”¨types.Part.from_dict()æ–¹æ³•åŒ…è£…
    
    Args:
        image_result: generate_doro_selfie_with_attractionè¿”å›çš„ç»“æœ
        
    Returns:
        types.Partå¯¹è±¡ï¼Œç¬¦åˆVeo 3 APIè¦æ±‚
    """
    try:
        # ä¼˜å…ˆä»æ–‡ä»¶è·¯å¾„åŠ è½½ï¼ˆæœ€å¯é ï¼‰
        if 'filepath' in image_result and os.path.exists(image_result['filepath']):
            logger.info(f"ğŸ“ ä»æ–‡ä»¶åŠ è½½ç°æœ‰åˆæˆå›¾ç‰‡: {image_result['filepath']}")
            with open(image_result['filepath'], 'rb') as f:
                image_bytes = f.read()
            image_base64 = base64.b64encode(image_bytes).decode('utf-8')
        
        # å¤‡é€‰ï¼šä»base64æ•°æ®åŠ è½½
        elif 'image_url' in image_result:
            logger.info("ğŸ“¦ ä»base64æ•°æ®åŠ è½½ç°æœ‰åˆæˆå›¾ç‰‡")
            image_base64 = image_result['image_url'].split(',')[1]
        
        else:
            raise ValueError("æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®")
        
        # ğŸ”‘ å…³é”®ï¼šä½¿ç”¨types.Part.from_dict()åŒ…è£…ï¼Œè€Œä¸æ˜¯ç›´æ¥å­—å…¸
        from google.genai import types
        generated_image = types.Part.from_dict({
            "inline_data": {
                "mime_type": "image/png",
                "data": image_base64
            }
        })
        
        return generated_image
            
    except Exception as e:
        logger.error(f"âŒ è½¬æ¢ç°æœ‰å›¾ç‰‡æ ¼å¼å¤±è´¥: {e}")
        raise Exception(f"å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥: {e}")
```

### æˆåŠŸæ¡ˆä¾‹å¯¹æ¯”åˆ†æ

#### âŒ å¤±è´¥çš„æ–¹æ³•ï¼ˆç›´æ¥å­—å…¸ï¼‰
```python
# è¿™ç§æ–¹å¼ä¼šå¯¼è‡´PydanticéªŒè¯é”™è¯¯
return {
    "bytesBase64Encoded": image_base64,
    "mimeType": "image/png"
}
```

#### âœ… æˆåŠŸçš„æ–¹æ³•ï¼ˆtypes.PartåŒ…è£…ï¼‰
```python
# æ­£ç¡®çš„æ–¹å¼ï¼šä½¿ç”¨SDKæä¾›çš„ç±»å‹åŒ…è£…
from google.genai import types
generated_image = types.Part.from_dict({
    "inline_data": {
        "mime_type": "image/png",  # æ³¨æ„ï¼šè¿™é‡Œæ˜¯mime_typeï¼Œä¸æ˜¯mimeType
        "data": image_base64
    }
})
```

#### âœ… æœ€ä½³æ–¹æ³•ï¼ˆImagen 3åŸç”Ÿå¯¹è±¡ï¼‰
```python
# å¦‚æœä½¿ç”¨Imagen 3ç”Ÿæˆï¼Œç›´æ¥ä½¿ç”¨åŸç”Ÿå¯¹è±¡
imagen_response = client.models.generate_images(
    model="imagen-3.0-generate-002",
    prompt=image_prompt,
)
generated_image = imagen_response.generated_images[0].image  # åŸç”Ÿå¯¹è±¡
```

### æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **å¯¹è±¡ç±»å‹éªŒè¯**ï¼šgoogle-genai SDKä½¿ç”¨Pydanticè¿›è¡Œä¸¥æ ¼çš„å‚æ•°éªŒè¯
2. **æ­£ç¡®çš„åŒ…è£…æ–¹å¼**ï¼šå¿…é¡»ä½¿ç”¨`types.Part.from_dict()`è€Œä¸æ˜¯ç›´æ¥å­—å…¸
3. **å­—æ®µå‘½åå·®å¼‚**ï¼šæ³¨æ„`mime_type`ï¼ˆä¸‹åˆ’çº¿ï¼‰vs `mimeType`ï¼ˆé©¼å³°ï¼‰
4. **æ•°æ®ç»“æ„å±‚æ¬¡**ï¼šä½¿ç”¨`inline_data`åµŒå¥—ç»“æ„

### ä¿®å¤å®æ–½æ–¹æ¡ˆ

ä¿®æ”¹`_convert_existing_to_imagen_format`æ–¹æ³•ï¼Œä½¿ç”¨æ­£ç¡®çš„`types.Part.from_dict()`åŒ…è£…ï¼š

```python
# åœ¨generate_doro_video_with_attractionæ–¹æ³•ä¸­
generated_image = self._convert_existing_to_imagen_format(image_result)

# APIè°ƒç”¨ä¿æŒä¸å˜
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=generated_image,  # ç°åœ¨æ˜¯types.Partå¯¹è±¡
    config=types.GenerateVideosConfig(aspect_ratio="16:9"),
)
```

---

**æ›´æ–°æ—¶é—´**ï¼š2025-09-05  
**ç‰ˆæœ¬**ï¼šv2.0  
**çŠ¶æ€**ï¼šéœ€è¦é‡æ–°å®æ–½ï¼ˆä½¿ç”¨types.Part.from_dictæ–¹æ³•ï¼‰


é—®é¢˜èƒŒæ™¯
åœ¨ä½¿ç”¨Google Generative AI Python SDKçš„gemini-pro-visionæ¨¡å‹å¤„ç†å›¾åƒæ—¶ï¼Œå¼€å‘è€…é‡åˆ°äº†ä¸€ä¸ªå…³äºPNGå›¾åƒæ ¼å¼å¤„ç†çš„å¼‚å¸¸é—®é¢˜ã€‚å½“å°è¯•é€šè¿‡generate_contentæ–¹æ³•ä¼ å…¥RGBAæ¨¡å¼çš„PNGå›¾åƒæ—¶ï¼Œç³»ç»Ÿä¼šæŠ›å‡ºKeyError: 'RGBA'é”™è¯¯ï¼Œç»§è€Œå¯¼è‡´OSError: cannot write mode RGBA as JPEGå¼‚å¸¸ã€‚

æŠ€æœ¯åˆ†æ
æ ¸å¿ƒé—®é¢˜
SDKåœ¨å†…éƒ¨å¤„ç†å›¾åƒæ•°æ®æ—¶ï¼Œé»˜è®¤å°è¯•å°†å›¾åƒè½¬æ¢ä¸ºJPEGæ ¼å¼è¿›è¡Œä¼ è¾“ã€‚ç„¶è€Œï¼Œå½“é‡åˆ°å¸¦æœ‰Alphaé€šé“çš„RGBAæ¨¡å¼PNGå›¾åƒæ—¶ï¼ŒJPEGæ ¼å¼æ— æ³•æ”¯æŒé€æ˜åº¦é€šé“ï¼Œå¯¼è‡´è½¬æ¢å¤±è´¥ã€‚

æ ¹æœ¬åŸå› 
å›¾åƒå¤„ç†æµç¨‹ä¸­ç¼ºå°‘å¯¹RGBAæ¨¡å¼çš„æ˜¾å¼å¤„ç†
è‡ªåŠ¨æ ¼å¼è½¬æ¢é€»è¾‘æ²¡æœ‰è€ƒè™‘PNGçš„ç‰¹æ®Šæ€§
é”™è¯¯å¤„ç†æœºåˆ¶æœªèƒ½æä¾›æ¸…æ™°çš„è§£å†³æ–¹æ¡ˆæç¤º
è§£å†³æ–¹æ¡ˆ
ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
å¼€å‘è€…å¯ä»¥åœ¨ä¼ å…¥å›¾åƒå‰ï¼Œæ‰‹åŠ¨å°†RGBAæ¨¡å¼è½¬æ¢ä¸ºRGBæ¨¡å¼ï¼š

from PIL import Image

# åŸå§‹RGBAå›¾åƒ
rgba_image = Image.open("example.png")

# è½¬æ¢ä¸ºRGBæ¨¡å¼
rgb_image = rgba_image.convert("RGB")

# ç„¶åä¼ å…¥generate_content
response = model.generate_content([rgb_image, "æè¿°å†…å®¹"])
æœ€ä½³å®è·µå»ºè®®
åœ¨å›¾åƒé¢„å¤„ç†é˜¶æ®µç»Ÿä¸€æ ¼å¼è½¬æ¢
å¯¹äºéœ€è¦ä¿ç•™é€æ˜åº¦çš„åœºæ™¯ï¼Œå»ºè®®æ˜¾å¼æŒ‡å®šä½¿ç”¨PNGæ ¼å¼
å»ºç«‹å›¾åƒè¾“å…¥çš„æ ‡å‡†åŒ–å¤„ç†æµç¨‹
æŠ€æœ¯ç»†èŠ‚
PNGä¸JPEGæ ¼å¼å·®å¼‚
PNGæ”¯æŒé€æ˜åº¦é€šé“(Alpha)ï¼Œè€ŒJPEGä¸æ”¯æŒ
PNGé‡‡ç”¨æ— æŸå‹ç¼©ï¼ŒJPEGæ˜¯æœ‰æŸå‹ç¼©
å¯¹äºæ‘„å½±ç±»å›¾åƒï¼ŒJPEGé€šå¸¸æ›´é«˜æ•ˆï¼›å¯¹äºå›¾å½¢ç±»å›¾åƒï¼ŒPNGè´¨é‡æ›´å¥½
SDKå†…éƒ¨å¤„ç†æœºåˆ¶
Google Generative AI Python SDKåœ¨æ¥æ”¶å›¾åƒè¾“å…¥æ—¶ï¼Œä¼šå°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š

è¯†åˆ«è¾“å…¥å›¾åƒç±»å‹
è‡ªåŠ¨è½¬æ¢ä¸ºé€‚åˆä¼ è¾“çš„æ ¼å¼
æ„å»ºAPIè¯·æ±‚å†…å®¹
å‘é€è‡³æœåŠ¡ç«¯å¤„ç†
å¼€å‘å»ºè®®
åœ¨å›¾åƒé‡‡é›†é˜¶æ®µå°±åšå¥½æ ¼å¼æ ‡å‡†åŒ–
æ·»åŠ è¾“å…¥éªŒè¯é€»è¾‘
è€ƒè™‘å®ç°è‡ªåŠ¨æ ¼å¼è½¬æ¢çš„å°è£…å‡½æ•°
å¯¹ä¸åŒçš„å›¾åƒç±»å‹å»ºç«‹å¤„ç†ç­–ç•¥çŸ©é˜µ
æ€»ç»“
è¿™ä¸ªé—®é¢˜æ­ç¤ºäº†åœ¨AIæ¨¡å‹å¤„ç†å¤šåª’ä½“è¾“å…¥æ—¶æ ¼å¼å…¼å®¹æ€§çš„é‡è¦æ€§ã€‚å¼€å‘è€…éœ€è¦å……åˆ†ç†è§£ä¸åŒå›¾åƒæ ¼å¼çš„ç‰¹æ€§ï¼Œå¹¶åœ¨é¢„å¤„ç†é˜¶æ®µåšå¥½æ ¼å¼è½¬æ¢å·¥ä½œã€‚Google Generative AI Python SDKæœªæ¥ç‰ˆæœ¬å¯èƒ½ä¼šä¼˜åŒ–è¿™ä¸€è‡ªåŠ¨è½¬æ¢é€»è¾‘ï¼Œä½†åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå¼€å‘è€…éœ€è¦ä¸»åŠ¨å¤„ç†RGBAæ¨¡å¼çš„è½¬æ¢é—®é¢˜ã€‚

é€šè¿‡éµå¾ªæœ¬æ–‡æå‡ºçš„è§£å†³æ–¹æ¡ˆå’Œæœ€ä½³å®è·µï¼Œå¼€å‘è€…å¯ä»¥ç¡®ä¿å›¾åƒæ•°æ®èƒ½å¤Ÿæ­£ç¡®ä¼ é€’ç»™gemini-pro-visionæ¨¡å‹ï¼Œè·å¾—é¢„æœŸçš„AIç”Ÿæˆç»“æœã€‚

