# Google Veo 3 è§†é¢‘ç”Ÿæˆå›¾ç‰‡å‚æ•°é—®é¢˜åˆ†æä¸æ”¹è¿›å»ºè®®

## é—®é¢˜åˆ†æ

### å½“å‰ä»£ç é—®é¢˜

åœ¨ `backend/gemini_service.py` çš„ `generate_doro_video_with_attraction` æ–¹æ³•ä¸­ï¼Œå½“å‰ä½¿ç”¨çš„å›¾ç‰‡å‚æ•°æ ¼å¼ï¼š

```python
# å½“å‰æœ‰é—®é¢˜çš„å®ç° (ç¬¬946-958è¡Œ)
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image={
        "bytesBase64Encoded": image_base64,
        "mimeType": "image/png",
    },
    config=types.GenerateVideosConfig(
        aspect_ratio="16:9",
    ),
)
```

### é—®é¢˜æ ¹æº

1. **å‚æ•°æ ¼å¼é”™è¯¯**ï¼šä½¿ç”¨äº†å­—å…¸æ ¼å¼ `{"bytesBase64Encoded": ..., "mimeType": ...}`
2. **APIä¸å…¼å®¹**ï¼šVeo 3 APIæœŸæœ›çš„æ˜¯åŸå§‹å›¾ç‰‡å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æ„é€ çš„å­—å…¸
3. **æ•°æ®è½¬æ¢å†—ä½™**ï¼šå…ˆä¿å­˜PNGæ–‡ä»¶ï¼Œå†è¯»å–è½¬base64ï¼Œå¢åŠ äº†ä¸å¿…è¦çš„I/Oæ“ä½œ

## æ­£ç¡®çš„å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šImagen 3 ä¸»è·¯å¾„ï¼ˆæ¨èï¼‰

```python
try:
    # ä¸»è·¯å¾„ï¼šä½¿ç”¨ Imagen 3 ç”Ÿæˆé™æ€å›¾ç‰‡ï¼Œå¹¶ç›´æ¥ä¼ åŸå§‹ image å¯¹è±¡
    logger.info("ğŸ¨ ä½¿ç”¨ Imagen 3 ç”Ÿæˆé™æ€å›¾ç‰‡ï¼ˆä¸»è·¯å¾„ï¼‰...")
    imagen_response = client.models.generate_images(
        model="imagen-3.0-generate-002",
        prompt=image_prompt,
    )
    if not imagen_response.generated_images:
        raise Exception("Imagenæœªç”Ÿæˆå›¾ç‰‡")
    
    # ç›´æ¥ä½¿ç”¨ Imagen è¿”å›çš„åŸå§‹å›¾ç‰‡å¯¹è±¡
    generated_image = imagen_response.generated_images[0].image
    logger.info("âœ… Imagen 3 é™æ€å›¾ç‰‡ç”ŸæˆæˆåŠŸ")
    
    # ä¿å­˜ä¸€ä»½åˆ°ç£ç›˜ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºä¸æ’æŸ¥
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    safe_name = "".join(c for c in attraction_info.get('name', 'unknown') if c.isalnum() or c in ('_', '-'))[:30]
    imagen_filename = f"imagen_{safe_name}_{timestamp}.png"
    imagen_filepath = os.path.join(self.output_dir, imagen_filename)
    
    if hasattr(generated_image, 'save'):
        generated_image.save(imagen_filepath)
    elif hasattr(generated_image, 'data'):
        with open(imagen_filepath, 'wb') as f:
            f.write(generated_image.data)
    
    with open(imagen_filepath, 'rb') as f:
        img_data = f.read()
    img_base64 = base64.b64encode(img_data).decode()
    
    image_result = {
        'image_url': f"data:image/png;base64,{img_base64}",
        'filename': imagen_filename,
        'filepath': imagen_filepath
    }

except Exception as e:
    logger.error(f"âŒ Imagenç”Ÿæˆå¤±è´¥ï¼Œèµ°é™çº§è·¯å¾„: {e}")
    # é™çº§è·¯å¾„ï¼šä½¿ç”¨ç°æœ‰åˆå½±ç”Ÿæˆæ–¹æ³•
```

### æ–¹æ¡ˆäºŒï¼šé™çº§è·¯å¾„ï¼ˆPart inline_dataç»“æ„ï¼‰

```python
# é™çº§è·¯å¾„ï¼šä½¿ç”¨ç°æœ‰åˆå½±ç”Ÿæˆï¼ˆå«ç”¨æˆ·ä¸Doroå‚ç…§å›¾ï¼‰ï¼Œå¹¶ä»¥ SDK Part inline_data ç»“æ„ä¼ å…¥è§†é¢‘æ¥å£
logger.info("ğŸ“¸ ä½¿ç”¨åˆå½±ç”Ÿæˆï¼ˆå«å‚ç…§å›¾ç‰‡ï¼‰ä½œä¸ºé™çº§è·¯å¾„...")
success, message, image_result = await self.generate_doro_selfie_with_attraction(
    user_photo=user_photo,
    doro_photo=doro_photo,
    style_photo=style_photo,
    attraction_info=attraction_info
)
if not success:
    return False, f"å›¾ç‰‡ç”Ÿæˆå¤±è´¥: {message}", None

# å°†åˆå½±çš„ base64 åŒ…è£…ä¸º Part inline_dataï¼ˆæ³¨æ„ä¸‹åˆ’çº¿å‘½åï¼‰
from google.genai import types
image_base64 = image_result['image_url'].split(',')[1]
generated_image = types.Part.from_dict({
    "inline_data": {
        "mime_type": "image/png",
        "data": image_base64
    }
})
```

### ç»Ÿä¸€çš„è§†é¢‘ç”Ÿæˆè°ƒç”¨

```python
# ç¬¬äºŒæ­¥ï¼šä½¿ç”¨Veo 3ç”Ÿæˆè§†é¢‘
logger.info("ğŸ¬ ç¬¬äºŒæ­¥ï¼šä½¿ç”¨Veo 3ç”ŸæˆåŠ¨æ€è§†é¢‘...")

# ç”Ÿæˆè§†é¢‘æç¤ºè¯ï¼ˆä¼ é€’å›¾ç‰‡æç¤ºè¯ä»¥ä¿æŒä¸€è‡´æ€§ï¼‰
video_prompt = self._generate_video_prompt(
    attraction_info, 
    (1024, 1024),
    image_prompt=image_prompt  # ä¼ é€’å›¾ç‰‡æç¤ºè¯
)
logger.info(f"ğŸ¬ è§†é¢‘æç¤ºè¯: {video_prompt[:200]}...")

# è°ƒç”¨Veo 3ç”Ÿæˆè§†é¢‘ï¼Œä½¿ç”¨æ­£ç¡®çš„å›¾ç‰‡å¯¹è±¡æ ¼å¼
operation = client.models.generate_videos(
    model="veo-3.0-generate-preview",
    prompt=video_prompt,
    image=generated_image,  # ç›´æ¥ä½¿ç”¨å›¾ç‰‡å¯¹è±¡ï¼Œæ— è®ºæ˜¯Imagenè¿˜æ˜¯Partæ ¼å¼
    config=types.GenerateVideosConfig(
        aspect_ratio="16:9",
    ),
)
```

## å…³é”®æ”¹è¿›ç‚¹

### 1. å›¾ç‰‡å¯¹è±¡æ ¼å¼ç»Ÿä¸€

- **ä¸»è·¯å¾„**ï¼šç›´æ¥ä½¿ç”¨ `imagen_response.generated_images[0].image`
- **é™çº§è·¯å¾„**ï¼šä½¿ç”¨ `types.Part.from_dict()` åŒ…è£…base64æ•°æ®

### 2. é¿å…æ‰‹åŠ¨æ„é€ å­—å…¸

âŒ **é”™è¯¯åšæ³•**ï¼š
```python
image={
    "bytesBase64Encoded": image_base64,
    "mimeType": "image/png",
}
```

âœ… **æ­£ç¡®åšæ³•**ï¼š
```python
image=generated_image  # ç›´æ¥ä¼ é€’å›¾ç‰‡å¯¹è±¡
```

### 3. åŒé‡ç­–ç•¥ä¿éšœ

- **ä¸»è·¯å¾„**ï¼šImagen 3ç›´æ¥ç”Ÿæˆ â†’ åŸå§‹å¯¹è±¡ä¼ é€’
- **é™çº§è·¯å¾„**ï¼šç°æœ‰åˆå½±ç”Ÿæˆ â†’ Part.from_dictåŒ…è£…

### 4. é”™è¯¯å¤„ç†ä¼˜åŒ–

```python
try:
    # ä¸»è·¯å¾„ï¼šImagen 3
    generated_image = imagen_response.generated_images[0].image
except Exception as e:
    logger.error(f"âŒ Imagenç”Ÿæˆå¤±è´¥ï¼Œèµ°é™çº§è·¯å¾„: {e}")
    # é™çº§è·¯å¾„ï¼šç°æœ‰æ–¹æ³• + PartåŒ…è£…
```

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### APIå…¼å®¹æ€§

1. **Veo 3æœŸæœ›æ ¼å¼**ï¼šåŸå§‹å›¾ç‰‡å¯¹è±¡æˆ–æ­£ç¡®çš„SDKç±»å‹
2. **ä¸æ”¯æŒæ ¼å¼**ï¼šæ‰‹åŠ¨æ„é€ çš„å­—å…¸ç»“æ„
3. **SDKç‰ˆæœ¬é”å®š**ï¼š
   - `google-generativeai==0.8.5`
   - `google-genai==1.33.0`

### æ•°æ®æµä¼˜åŒ–

```
ç”¨æˆ·è¾“å…¥ â†’ Imagen 3ç”Ÿæˆ â†’ åŸå§‹å¯¹è±¡ â†’ Veo 3è§†é¢‘
       â†“ (å¤±è´¥æ—¶)
       â†’ ç°æœ‰åˆå½±ç”Ÿæˆ â†’ base64æå– â†’ PartåŒ…è£… â†’ Veo 3è§†é¢‘
```

### æ€§èƒ½ä¼˜åŒ–

- å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶I/Oæ“ä½œ
- é¿å…é‡å¤çš„base64ç¼–è§£ç 
- ç›´æ¥ä½¿ç”¨APIè¿”å›çš„åŸå§‹å¯¹è±¡

## å®æ–½å»ºè®®

### ç«‹å³ä¿®æ”¹

1. å°†å½“å‰çš„å­—å…¸æ ¼å¼æ”¹ä¸ºåŒé‡ç­–ç•¥
2. æ·»åŠ Imagen 3ä¸»è·¯å¾„
3. ä¿ç•™ç°æœ‰æ–¹æ³•ä½œä¸ºé™çº§è·¯å¾„

### æµ‹è¯•éªŒè¯

1. æµ‹è¯•Imagen 3ä¸»è·¯å¾„çš„æˆåŠŸç‡
2. éªŒè¯é™çº§è·¯å¾„çš„å…¼å®¹æ€§
3. ç¡®è®¤è§†é¢‘ç”Ÿæˆè´¨é‡

### ç›‘æ§æŒ‡æ ‡

- Imagen 3æˆåŠŸç‡
- é™çº§è·¯å¾„ä½¿ç”¨é¢‘ç‡
- æ•´ä½“è§†é¢‘ç”ŸæˆæˆåŠŸç‡
- ç”Ÿæˆæ—¶é—´å¯¹æ¯”

## é¢„æœŸæ•ˆæœ

1. **æé«˜æˆåŠŸç‡**ï¼šåŒé‡ç­–ç•¥ä¿éšœ
2. **å‡å°‘é”™è¯¯**ï¼šé¿å…APIå‚æ•°æ ¼å¼é—®é¢˜
3. **æå‡æ€§èƒ½**ï¼šå‡å°‘ä¸å¿…è¦çš„æ•°æ®è½¬æ¢
4. **å¢å¼ºç¨³å®šæ€§**ï¼šä¸»è·¯å¾„+é™çº§è·¯å¾„çš„å®¹é”™æœºåˆ¶

---

**æ›´æ–°æ—¶é—´**ï¼š2025-09-05  
**ç‰ˆæœ¬**ï¼šv1.0  
**çŠ¶æ€**ï¼šå¾…å®æ–½
