<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½æµ‹è¯• - æ–¹å‘æ¢ç´¢æ´¾å¯¹</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title { color: #2563eb; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .test-button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            transition: background 0.2s;
        }
        .test-button:hover { background: #1d4ed8; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .hidden { display: none; }
        .language-dropdown { 
            position: relative;
            background: white; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            max-height: 200px; 
            overflow-y: auto;
            margin-top: 10px;
        }
        .language-option { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .language-option:hover { background: #f3f4f6; }
        .language-option.active { background: #2563eb; color: white; }
        .language-flag { margin-right: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>ğŸ§­ æ–¹å‘æ¢ç´¢æ´¾å¯¹ - åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <div class="test-title">1. è¯­è¨€é€‰æ‹©å™¨æµ‹è¯•</div>
        <button class="test-button" onclick="testLanguageSelector()">æµ‹è¯•è¯­è¨€é€‰æ‹©å™¨</button>
        <button class="test-button" onclick="toggleLanguageDropdown()">åˆ‡æ¢è¯­è¨€ä¸‹æ‹‰èœå•</button>
        <div class="language-dropdown hidden" id="language-dropdown">
            <!-- è¯­è¨€é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="status info" id="language-status">ç‚¹å‡»æŒ‰é’®æµ‹è¯•è¯­è¨€é€‰æ‹©å™¨åŠŸèƒ½</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">2. ç”¨æˆ·èœå•æµ‹è¯•</div>
        <button class="test-button" onclick="testUserMenu()">æµ‹è¯•ç”¨æˆ·èœå•</button>
        <button class="test-button" onclick="toggleUserMenu()">åˆ‡æ¢ç”¨æˆ·èœå•</button>
        <div class="user-dropdown hidden" id="user-dropdown">
            <div style="padding: 10px; border: 1px solid #ccc; background: white; border-radius: 4px; margin-top: 10px;">
                <div id="user-email">æœªç™»å½•</div>
                <button onclick="showAuthModal('login')" id="login-btn">ç™»å½•</button>
                <button onclick="showAuthModal('register')" id="register-btn">æ³¨å†Œ</button>
                <button onclick="logout()" id="logout-btn" class="hidden">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        <div class="status info" id="user-status">ç‚¹å‡»æŒ‰é’®æµ‹è¯•ç”¨æˆ·èœå•åŠŸèƒ½</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">3. ç™»å½•çŠ¶æ€æ£€æŸ¥æµ‹è¯•</div>
        <button class="test-button" onclick="testLoginCheck()">æ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</button>
        <button class="test-button" onclick="testRequireLogin()">æµ‹è¯•éœ€è¦ç™»å½•çš„åŠŸèƒ½</button>
        <button class="test-button" onclick="simulatePhotoGeneration()">æ¨¡æ‹Ÿç”Ÿæˆåˆå½±</button>
        <button class="test-button" onclick="simulateDoroPhoto()">æ¨¡æ‹ŸDoroåˆå½±</button>
        <button class="test-button" onclick="simulateStreetView()">æ¨¡æ‹ŸæŸ¥çœ‹è¡—æ™¯</button>
        <div class="status info" id="login-status">ç‚¹å‡»æŒ‰é’®æµ‹è¯•ç™»å½•ç›¸å…³åŠŸèƒ½</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">4. æ–°çª—å£ç™»å½•æµ‹è¯•</div>
        <button class="test-button" onclick="openLoginWindow()">æ‰“å¼€ç™»å½•çª—å£</button>
        <div class="status info" id="window-status">ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ–°çª—å£ç™»å½•åŠŸèƒ½</div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="i18n/index.js"></script>
    
    <script>
        // æ¨¡æ‹Ÿä¸»é¡µé¢çš„å…¨å±€å˜é‡å’Œå‡½æ•°
        let currentLanguage = 'zh';
        let currentUser = null;
        
        // æ¨¡æ‹Ÿç¿»è¯‘æ•°æ®
        window.translations = {
            zh: {
                guest: "æ¸¸å®¢",
                notLoggedIn: "æœªç™»å½•",
                login: "ç™»å½•",
                register: "æ³¨å†Œ",
                logout: "é€€å‡ºç™»å½•"
            },
            en: {
                guest: "Guest",
                notLoggedIn: "Not Logged In",
                login: "Login",
                register: "Register",
                logout: "Logout"
            }
        };

        // å…³é”®å‡½æ•°å®šä¹‰
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('language-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                updateStatus('language-status', 'info', 'è¯­è¨€ä¸‹æ‹‰èœå•åˆ‡æ¢: ' + (dropdown.classList.contains('hidden') ? 'éšè—' : 'æ˜¾ç¤º'));
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                updateStatus('user-status', 'info', 'ç”¨æˆ·èœå•åˆ‡æ¢: ' + (dropdown.classList.contains('hidden') ? 'éšè—' : 'æ˜¾ç¤º'));
            }
        }

        function checkLoginStatus() {
            const token = localStorage.getItem('access_token');
            return !!token;
        }

        function requireLogin(callback, ...args) {
            if (checkLoginStatus()) {
                updateStatus('login-status', 'success', 'ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡ŒåŠŸèƒ½');
                callback.apply(this, args);
            } else {
                updateStatus('login-status', 'error', 'ç”¨æˆ·æœªç™»å½•ï¼Œéœ€è¦å…ˆç™»å½•');
                const loginUrl = window.location.origin + '/login.html';
                const loginWindow = window.open(loginUrl, 'login', 'width=500,height=700,scrollbars=yes,resizable=yes');
                
                const messageHandler = (event) => {
                    if (event.origin !== window.location.origin) return;
                    if (event.data.type === 'login-success') {
                        updateStatus('login-status', 'success', 'ç™»å½•æˆåŠŸï¼æ‰§è¡ŒåŸå§‹æ“ä½œ');
                        window.removeEventListener('message', messageHandler);
                        callback.apply(this, args);
                    }
                };
                
                window.addEventListener('message', messageHandler);
            }
        }

        // æµ‹è¯•å‡½æ•°
        function testLanguageSelector() {
            try {
                const languages = i18n.getSupportedLanguages();
                generateLanguageOptions();
                updateStatus('language-status', 'success', `è¯­è¨€é€‰æ‹©å™¨æ­£å¸¸ï¼Œæ”¯æŒ ${languages.length} ç§è¯­è¨€`);
            } catch (error) {
                updateStatus('language-status', 'error', 'è¯­è¨€é€‰æ‹©å™¨é”™è¯¯: ' + error.message);
            }
        }

        function generateLanguageOptions() {
            const dropdown = document.getElementById('language-dropdown');
            if (!dropdown) return;
            
            const languages = i18n.getSupportedLanguages();
            dropdown.innerHTML = languages.map(lang => `
                <div class="language-option ${lang.code === currentLanguage ? 'active' : ''}" 
                     onclick="changeLanguage('${lang.code}')">
                    <span class="language-flag">${lang.flag}</span>
                    <span class="language-name">${lang.name}</span>
                </div>
            `).join('');
        }

        function changeLanguage(langCode) {
            if (i18n.changeLanguage(langCode)) {
                currentLanguage = langCode;
                generateLanguageOptions();
                updateStatus('language-status', 'success', `è¯­è¨€å·²åˆ‡æ¢åˆ°: ${langCode}`);
                toggleLanguageDropdown();
            }
        }

        function testUserMenu() {
            const isLoggedIn = checkLoginStatus();
            updateUserUI(isLoggedIn ? { username: 'æµ‹è¯•ç”¨æˆ·', email: 'test@example.com' } : null);
            updateStatus('user-status', 'info', `ç”¨æˆ·çŠ¶æ€: ${isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);
        }

        function updateUserUI(user) {
            const t = window.translations[currentLanguage] || window.translations['zh'];
            const userEmailEl = document.getElementById('user-email');
            const loginBtnEl = document.getElementById('login-btn');
            const registerBtnEl = document.getElementById('register-btn');
            const logoutBtnEl = document.getElementById('logout-btn');
            
            if (user) {
                if (userEmailEl) userEmailEl.textContent = user.email;
                if (loginBtnEl) loginBtnEl.classList.add('hidden');
                if (registerBtnEl) registerBtnEl.classList.add('hidden');
                if (logoutBtnEl) logoutBtnEl.classList.remove('hidden');
            } else {
                if (userEmailEl) userEmailEl.textContent = t.notLoggedIn || 'æœªç™»å½•';
                if (loginBtnEl) loginBtnEl.classList.remove('hidden');
                if (registerBtnEl) registerBtnEl.classList.remove('hidden');
                if (logoutBtnEl) logoutBtnEl.classList.add('hidden');
            }
        }

        function testLoginCheck() {
            const isLoggedIn = checkLoginStatus();
            const token = localStorage.getItem('access_token');
            updateStatus('login-status', isLoggedIn ? 'success' : 'error', 
                `ç™»å½•çŠ¶æ€: ${isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}${token ? ' (Token: ' + token.substring(0, 20) + '...)' : ''}`);
        }

        function testRequireLogin() {
            requireLogin(() => {
                updateStatus('login-status', 'success', 'ç™»å½•æ£€æŸ¥é€šè¿‡ï¼ŒåŠŸèƒ½æ‰§è¡ŒæˆåŠŸï¼');
            });
        }

        function simulatePhotoGeneration() {
            requireLogin(() => {
                updateStatus('login-status', 'success', 'ğŸ“¸ ç”Ÿæˆåˆå½±åŠŸèƒ½æ‰§è¡ŒæˆåŠŸï¼');
            });
        }

        function simulateDoroPhoto() {
            requireLogin(() => {
                updateStatus('login-status', 'success', 'ğŸ¤ Doroåˆå½±åŠŸèƒ½æ‰§è¡ŒæˆåŠŸï¼');
            });
        }

        function simulateStreetView() {
            requireLogin(() => {
                updateStatus('login-status', 'success', 'ğŸ™ï¸ æŸ¥çœ‹è¡—æ™¯åŠŸèƒ½æ‰§è¡ŒæˆåŠŸï¼');
            });
        }

        function openLoginWindow() {
            const loginUrl = window.location.origin + '/login.html';
            const loginWindow = window.open(loginUrl, 'login', 'width=500,height=700,scrollbars=yes,resizable=yes');
            updateStatus('window-status', 'info', 'ç™»å½•çª—å£å·²æ‰“å¼€');
            
            const messageHandler = (event) => {
                if (event.origin !== window.location.origin) return;
                if (event.data.type === 'login-success') {
                    updateStatus('window-status', 'success', 'æ”¶åˆ°ç™»å½•æˆåŠŸæ¶ˆæ¯ï¼');
                    window.removeEventListener('message', messageHandler);
                }
            };
            
            window.addEventListener('message', messageHandler);
        }

        function updateStatus(elementId, type, message) {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.className = `status ${type}`;
                statusEl.textContent = message;
            }
        }

        // æ¨¡æ‹Ÿå…¶ä»–å¿…è¦å‡½æ•°
        function showAuthModal(type) {
            updateStatus('user-status', 'info', `å°è¯•æ‰“å¼€${type}æ¨¡æ€æ¡†`);
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            updateStatus('user-status', 'success', 'å·²é€€å‡ºç™»å½•');
            testUserMenu();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            testLanguageSelector();
            testUserMenu();
            testLoginCheck();
        });
    </script>
</body>
</html>
