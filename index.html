<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方向探索派对智能工具</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles_doro.css">
</head>
<body>
    <div class="app-container">
        <!-- 头部导航 -->
        <header class="header">
            <h1>🧭 方向探索派对</h1>
            <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
        </header>

        <!-- 设置面板 -->
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-group">
                <label>目标距离:</label>
                <select id="segmentDistance" onchange="updateSettings()">
                    <option value="5">5km</option>
                    <option value="10" selected>10km</option>
                    <option value="15">15km</option>
                    <option value="20">20km</option>
                </select>
            </div>
            <div class="setting-group">
                <label>模式:</label>
                <select id="timeMode" onchange="updateSettings()">
                    <option value="present" selected>现代模式</option>
                    <option value="past">古代模式</option>
                </select>
            </div>

            <div class="setting-group">
                <label>速度 (km/h):</label>
                <input type="number" id="speed" value="120" min="1" max="1000" onchange="updateSettings()">
            </div>

            <!-- 漫游功能 -->
            <div class="setting-group roaming-section">
                <label class="roaming-title">🌍 漫游到:</label>
                <div class="roaming-inputs">
                    <div class="input-row">
                        <label>国家:</label>
                        <input type="text" id="roamingCountry" placeholder="如：中国" class="roaming-input">
                    </div>
                    <div class="input-row">
                        <label>城市:</label>
                        <input type="text" id="roamingCity" placeholder="如：北京" class="roaming-input">
                    </div>
                    <div class="input-row">
                        <label>景点:</label>
                        <input type="text" id="roamingPlace" placeholder="如：天安门广场" class="roaming-input">
                    </div>
                </div>
                <button class="roaming-btn" onclick="confirmRoaming()">🚀 确认漫游到</button>
                <div class="roaming-status" id="roamingStatus" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>正在搜索目标位置...</span>
                </div>
            </div>
        </div>

        <!-- 状态显示区 -->
        <div class="status-section">
            <div class="location-info">
                <div class="current-location">
                    <span class="label">当前位置:</span>
                    <span id="currentLocation">获取中...</span>
                </div>
                <div class="coordinates-info">
                    <span class="label">经纬度:</span>
                    <span id="coordinates">--°, --°</span>
                </div>
                <div class="accuracy-info">
                    <span class="label">精度:</span>
                    <span id="accuracy">--m</span>
                </div>
                <div class="compass-info">
                    <span class="label">朝向:</span>
                    <span id="compassDirection">--°</span>
                </div>
                <div class="direction-text">
                    <span class="label">方向:</span>
                    <span id="directionText">--</span>
                </div>
            </div>
            
            <!-- 指南针显示 -->
            <div class="compass-container">
                <div class="compass" id="compass">
                    <div class="compass-needle" id="compassNeedle">
                        <div class="needle-diamond">
                            <div class="needle-north"></div>
                            <div class="needle-south"></div>
                        </div>
                    </div>
                    <div class="compass-center"></div>
                    <div class="compass-directions">
                        <div class="direction north">N</div>
                        <div class="direction east">E</div>
                        <div class="direction south">S</div>
                        <div class="direction west">W</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="controls">
            <button class="explore-btn" id="exploreBtn" onclick="startExploration()">
                🚀 开始探索
            </button>
            <button class="refresh-btn" onclick="refreshLocation()">
                📍 刷新位置
            </button>
            <button class="end-journey-btn" id="endJourneyBtn" onclick="endJourney()" style="display: none;">
                🏠 结束旅程
            </button>
        </div>

        <!-- 历史访问场景 -->
        <div class="journey-history-section" id="journeyHistorySection" style="display: none;">
            <h3>🎒 已访问的地点</h3>
            <div class="history-places-container" id="historyPlacesContainer">
                <!-- 历史访问的地点卡片将在这里显示 -->
            </div>
        </div>

        <!-- 地点卡片容器 -->
        <div class="places-container" id="placesContainer">
            <!-- 地点卡片将在这里动态生成 -->
        </div>

        <!-- 加载指示器 -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>正在计算路径...</p>
        </div>

        <!-- 日志显示区 -->
        <div class="log-section">
            <div class="log-header">
                <h3>系统日志</h3>
                <button class="clear-log-btn" onclick="clearLogs()">清空日志</button>
            </div>
            <div class="log-container" id="logContainer">
                <!-- 日志信息将在这里显示 -->
            </div>
        </div>

        <!-- Google街景模态框 -->
        <div class="streetview-modal" id="streetviewModal" style="display: none;">
            <div class="streetview-modal-content">
                <div class="streetview-header">
                    <h3 id="streetviewTitle">🏙️ 街景视图</h3>
                    <button class="close-streetview-btn" onclick="closeStreetView()">✕</button>
                </div>
                <div class="streetview-controls">
                    <button class="streetview-control-btn" onclick="resetStreetViewHeading()" title="重置朝向">
                        🧭 重置视角
                    </button>
                    <button class="streetview-control-btn" onclick="toggleStreetViewFullscreen()" title="全屏">
                        🔍 全屏
                    </button>
                    <button class="streetview-control-btn" onclick="shareStreetView()" title="分享位置">
                        📤 分享
                    </button>
                </div>
                <div class="streetview-container" id="streetviewContainer">
                    <div class="streetview-loading" id="streetviewLoading">
                        <div class="streetview-spinner"></div>
                        <p>正在加载街景...</p>
                    </div>
                    <div class="streetview-error" id="streetviewError" style="display: none;">
                        <div class="error-icon">🚫</div>
                        <h4>街景不可用</h4>
                        <p id="streetviewErrorText">该位置暂时没有街景数据</p>
                        <button class="retry-streetview-btn" onclick="retryStreetView()">重试</button>
                    </div>
                </div>
                <div class="streetview-info" id="streetviewInfo">
                    <div class="streetview-location">
                        <span class="info-label">📍 位置:</span>
                        <span id="streetviewLocation">--</span>
                    </div>
                    <div class="streetview-coordinates">
                        <span class="info-label">📊 坐标:</span>
                        <span id="streetviewCoords">--</span>
                    </div>
                    <div class="streetview-date">
                        <span class="info-label">📅 拍摄时间:</span>
                        <span id="streetviewDate">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google街景遮罩层 -->
        <div class="streetview-overlay" id="streetviewOverlay" style="display: none;" onclick="closeStreetView()"></div>
        
        <!-- 景点合影生成模态框 -->
        <div class="selfie-modal" id="selfieModal" style="display: none;">
            <div class="selfie-modal-content">
                <button class="selfie-close-btn" onclick="closeSelfieModal()" title="关闭">
                    ✕
                </button>
                <div class="selfie-header">
                    <h3>📸 生成景点合影</h3>
                </div>
                
                <div class="selfie-body">
                    <div class="selfie-info">
                        <h4 id="selfieAttractionName">景点名称</h4>
                        <p id="selfieAttractionLocation">位置信息</p>
                    </div>
                    
                    <div class="selfie-upload-section" id="selfieUploadSection">
                        <div class="upload-section">
                            <div class="upload-group">
                                <h4>📷 您的照片</h4>
                                <div class="upload-area" id="uploadArea" onclick="document.getElementById('selfiePhotoInput').click()">
                                    <input type="file" id="selfiePhotoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                                    <div class="upload-placeholder" id="uploadPlaceholder">
                                        <div class="upload-icon">📷</div>
                                        <p>点击上传您的照片</p>
                                        <p class="upload-hint">支持 JPG、PNG 格式</p>
                                    </div>
                                    <img id="uploadPreview" class="upload-preview" style="display: none;" alt="预览图">
                                </div>
                            </div>
                            
                            <div class="upload-group">
                                <h4>🎨 范例风格图片（可选）</h4>
                                <div class="upload-area" id="styleUploadArea" onclick="document.getElementById('stylePhotoInput').click()">
                                    <input type="file" id="stylePhotoInput" accept="image/*" style="display: none;" onchange="handleStylePhotoUpload(event)">
                                    <div class="upload-placeholder" id="stylePlaceholder">
                                        <div class="upload-icon">🎨</div>
                                        <p>点击上传范例风格图片</p>
                                        <p class="upload-hint">用于模仿服装或风格</p>
                                    </div>
                                    <img id="stylePreview" class="upload-preview" style="display: none;" alt="风格预览图">
                                </div>
                            </div>
                        </div>
                        
                        <div class="prompt-section">
                            <label for="customPrompt">自定义提示词（可选）：</label>
                            <textarea id="customPrompt" rows="3" placeholder="输入额外要求，将追加到基础提示词后面。例如：按第二个橙色高子男生，换他的衣服和裤子服装，头像更换成当前主人的头像，只保留一个人"></textarea>
                        </div>
                        
                        <div class="selfie-actions">
                            <button class="generate-btn" id="generateBtn" onclick="generateSelfie()" disabled>
                                ✨ 生成合影
                            </button>
                            <button class="cancel-btn" onclick="closeSelfieModal()">
                                ❌ 取消
                            </button>
                        </div>
                    </div>
                    
                    <div class="selfie-loading" id="selfieLoading" style="display: none;">
                        <div class="loading-content">
                            <div class="selfie-spinner"></div>
                            <h4 class="loading-title">正在生成您的景点合影...</h4>
                            <p class="loading-hint">这可能需要 10-30 秒，请耐心等待 ⏰</p>
                        </div>
                    </div>
                    
                    <div class="selfie-result" id="selfieResult" style="display: none;">
                        <div class="generated-image-container">
                            <img id="generatedSelfie" class="generated-selfie" alt="生成的合影" onclick="showImageModal(this.src)">
                            <div class="image-hint">点击图片查看大图</div>
                        </div>
                        <div class="result-actions">
                            <button class="download-btn" onclick="downloadSelfie()">
                                💾 下载合影
                            </button>
                            <button class="regenerate-btn" onclick="regenerateWithCurrentStyle()">
                                🔄 当前风格重新生成
                            </button>
                            <button class="share-btn" onclick="shareSelfie()">
                                📤 分享合影
                            </button>
                        </div>
                    </div>
                    
                    <div class="selfie-error" id="selfieError" style="display: none;">
                        <div class="error-icon">❌</div>
                        <h4>生成失败</h4>
                        <p id="selfieErrorMessage">生成合影时出现错误，请重试</p>
                        <button class="retry-btn" onclick="resetSelfieGenerator()">重试</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 合影生成遮罩层 -->
        <div class="selfie-overlay" id="selfieOverlay" style="display: none;"></div>
        
        <!-- Doro合影生成模态框 -->
        <div class="doro-selfie-modal" id="doroSelfieModal" style="display: none;">
            <div class="doro-modal-content">
                <button class="doro-close-btn" onclick="closeDoroModal()" title="关闭">
                    ✕
                </button>
                <div class="doro-header">
                    <h3>🤝 Doro与我合影</h3>
                    <p class="doro-subtitle">创建您与虚拟伙伴Doro的精彩合影</p>
                </div>
                
                <div class="doro-body">
                    <div class="doro-info">
                        <h4 id="doroAttractionName">景点名称</h4>
                        <p id="doroAttractionLocation">位置信息</p>
                    </div>
                    
                    <!-- 上传区域 -->
                    <div class="upload-section">
                        <div class="upload-group">
                            <h4>📷 您的照片</h4>
                            <div class="upload-area" id="userPhotoArea" onclick="document.getElementById('doroUserPhotoInput').click()">
                                <input type="file" id="doroUserPhotoInput" accept="image/*" style="display: none;" onchange="handleDoroUserPhoto(event)">
                                <div class="upload-placeholder" id="userPhotoPlaceholder">
                                    <div class="upload-icon">📷</div>
                                    <p>点击上传您的照片</p>
                                    <p class="upload-hint">支持 JPG、PNG、WEBP 格式</p>
                                </div>
                                <img id="userPhotoPreview" class="upload-preview" style="display: none;" alt="您的照片">
                            </div>
                        </div>
                        
                        <div class="upload-group">
                            <h4>🎭 选择Doro形象</h4>
                            <div class="doro-selector-container">
                                <div class="doro-selector-tabs">
                                    <button class="doro-tab active" onclick="switchDoroTab('preset')">预设Doro</button>
                                    <button class="doro-tab" onclick="switchDoroTab('custom')">自定义Doro</button>
                                </div>
                                <div class="doro-selector-grid" id="doroSelectorGrid">
                                    <!-- 动态加载Doro列表 -->
                                </div>
                                <div class="doro-upload-custom" id="doroUploadCustom" style="display: none;">
                                    <div class="upload-area" onclick="document.getElementById('doroCustomInput').click()">
                                        <input type="file" id="doroCustomInput" accept="image/*" style="display: none;" onchange="handleCustomDoro(event)">
                                        <div class="upload-placeholder">
                                            <div class="upload-icon">➕</div>
                                            <p>上传自定义Doro形象</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 可选：服装风格参考 -->
                    <div class="upload-section">
                        <div class="upload-group">
                            <h4>👔 服装风格参考（可选）</h4>
                            <div class="upload-area" id="stylePhotoArea" onclick="document.getElementById('doroStyleInput').click()">
                                <input type="file" id="doroStyleInput" accept="image/*" style="display: none;" onchange="handleDoroStylePhoto(event)">
                                <div class="upload-placeholder" id="stylePlaceholder">
                                    <div class="upload-icon">👔</div>
                                    <p>点击上传服装风格参考</p>
                                    <p class="upload-hint">可选：用于统一服装风格</p>
                                </div>
                                <img id="doroStylePreview" class="upload-preview" style="display: none;" alt="风格参考">
                            </div>
                        </div>
                        
                        <div class="upload-group">
                            <h4>✏️ 自定义提示词（可选）</h4>
                            <textarea id="doroCustomPrompt" placeholder="输入额外要求，将追加到基础提示词后面。例如：按第二个橙色高子男生，换他的衣服和裤子服装，头像更换成当前主人的头像，只保留一个人" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="doro-actions">
                        <button class="doro-generate-btn" id="doroGenerateBtn" onclick="generateDoroSelfie()" disabled>
                            ✨ 生成Doro合影
                        </button>
                        <button class="doro-video-btn" id="doroVideoBtn" onclick="generateDoroVideo()" disabled>
                            🎬 生成Doro合影视频
                        </button>
                        <button class="doro-cancel-btn" onclick="closeDoroModal()">
                            ❌ 取消
                        </button>
                    </div>

                    
                    <!-- 加载状态 -->
                    <div class="doro-loading" id="doroLoading" style="display: none;">
                        <div class="loading-content">
                            <div class="doro-spinner"></div>
                            <h4 class="loading-title">正在生成Doro合影...</h4>
                            <p class="loading-hint">AI正在将您、Doro和景点完美融合 🎨</p>
                            <p class="loading-hint">预计需要 15-30 秒 ⏰</p>
                        </div>
                    </div>
                    
                    <!-- 结果展示 -->
                    <div class="doro-result" id="doroResult" style="display: none;">
                        <div class="generated-image-container">
                            <img id="generatedDoroSelfie" class="generated-selfie" alt="Doro合影" onclick="showImageModal(this.src)">
                            <div class="image-hint">点击图片查看大图</div>
                        </div>
                        <div class="result-actions">
                            <button class="download-btn" onclick="downloadDoroSelfie()">
                                💾 下载合影
                            </button>
                            <button class="regenerate-btn" onclick="regenerateDoroSelfie()">
                                🔄 重新生成
                            </button>
                            <button class="share-btn" onclick="shareDoroSelfie()">
                                📤 分享合影
                            </button>
                        </div>
                    </div>
                    
                    <!-- 视频结果展示 -->
                    <div class="doro-video-result" id="doroVideoResult" style="display: none;">
                        <div class="generated-video-container">
                            <video id="generatedDoroVideo" class="generated-video" controls>
                                您的浏览器不支持视频播放
                            </video>
                            <div class="video-hint">Doro合影视频已生成</div>
                        </div>
                        <div class="video-result-actions">
                            <button class="download-btn" onclick="downloadDoroVideo()">
                                💾 下载视频
                            </button>
                            <button class="regenerate-btn" onclick="regenerateDoroVideo()">
                                🔄 重新生成视频
                            </button>
                            <button class="share-btn" onclick="shareDoroVideo()">
                                📤 分享视频
                            </button>
                        </div>
                    </div>
                    
                    <!-- 错误提示 -->
                    <div class="doro-error" id="doroError" style="display: none;">
                        <div class="error-icon">🤖💥</div>
                        <h4>AI抛锚了</h4>
                        <p id="doroErrorMessage">这点小故障，你看肿么办？</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Doro合影遮罩层 -->
        <div class="doro-overlay" id="doroOverlay" style="display: none;"></div>
    </div>

    <!-- Google Maps JavaScript API 配置 -->
    <script>
        // API基础URL配置 - 支持环境变量控制
        function getAPIBaseURL() {
            // 检查是否在生产环境（通过域名访问）
            const isProduction = window.location.hostname === 'doro.gitagent.io' || 
                                 window.location.hostname.includes('gitagent.io');
            
            // 检查localStorage中的配置（优先级最高）
            const localStorageConfig = localStorage.getItem('isUsedomainnameaddress');
            
            // 检查URL参数
            const urlHasUseDomain = window.location.search.includes('usedomainname=true');
            const urlHasUseLocal = window.location.search.includes('usedomainname=false');
            
            // 决定使用哪个API URL
            if (localStorageConfig === 'false' && !isProduction) {
                // 明确设置为本地开发
                return 'http://localhost:8002';
            } else if (localStorageConfig === 'true' || urlHasUseDomain || isProduction) {
                // 生产环境或明确设置使用域名
                return 'https://doro.gitagent.io';
            } else if (urlHasUseLocal) {
                // URL参数明确指定使用本地
                return 'http://localhost:8002';
            } else {
                // 默认：如果通过域名访问则使用域名，否则使用本地
                return isProduction ? 'https://doro.gitagent.io' : 'http://localhost:8002';
            }
        }
        
        const API_BASE_URL = getAPIBaseURL();
        console.log('🔧 API_BASE_URL配置:', API_BASE_URL);
        
        // 应用配置 - API Key配置在环境变量中
        window.appConfig = {
            // 注意：实际部署时应从后端或环境变量获取此值
            // 不要将真实的API Key提交到代码库！
            // 开发时请在 .env 文件中设置 GOOGLE_MAPS_API_KEY
            googleMapsApiKey: 'AIzaSyC3fc8-5r4SWOISs0IIduiE4TOvE8-aFC0', // 将被动态替换
            useLangchain: true
        };

        // 尝试从后端获取API配置（生产环境推荐）
        async function loadAppConfig() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/config/maps`);
                if (response.ok) {
                    const config = await response.json();
                    window.appConfig.googleMapsApiKey = config.google_maps_api_key;
                    console.log('✅ 从后端获取到API配置');
                }
            } catch (error) {
                console.log('⚠️ 无法从后端获取API配置，使用默认配置');
            }
        }

        // 添加全局状态变量
        window.googleMapsLoadStatus = 'pending'; // pending, loading, loaded, failed

        // Google Maps API 回调函数
        window.initGoogleMaps = function() {
            console.log('✅ Google Maps API 已加载');
            console.log('🏙️ Street View 服务已准备就绪');
            window.googleMapsLoadStatus = 'loaded';

            // 初始化街景相关变量
            if (typeof initGoogleMapsAPI === 'function') {
                initGoogleMapsAPI();
            }
            
            // 触发自定义事件，通知API已加载
            window.dispatchEvent(new Event('googleMapsLoaded'));
        };

        // 动态加载Google Maps API
        function loadGoogleMapsAPI() {
            const apiKey = window.appConfig.googleMapsApiKey;
            
            console.log('🔍 开始加载Google Maps API');
            console.log('   API Key:', apiKey ? apiKey.substring(0, 10) + '...' : '未设置');

            if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.warn('⚠️ Google Maps API Key 未配置');
                window.googleMapsLoadStatus = 'failed';
                return false;
            }

            // 检查是否已经加载过
            if (window.google && window.google.maps) {
                console.log('✅ Google Maps API 已存在');
                window.googleMapsLoadStatus = 'loaded';
                window.initGoogleMaps();
                return true;
            }

            window.googleMapsLoadStatus = 'loading';
            console.log('🔄 正在加载 Google Maps API...');
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGoogleMaps&v=weekly&libraries=geometry`;
            script.async = true;
            script.defer = true;
            
            script.onload = function() {
                console.log('✅ Google Maps script标签加载完成');
            };
            
            script.onerror = function(error) {
                window.googleMapsLoadStatus = 'failed';
                console.error('❌ Google Maps API 加载失败');
                console.log('🔍 请检查:');
                console.log('   1. API Key 是否正确');
                console.log('   2. 网络连接是否正常');
                console.log('   3. API Key 是否有正确的权限');
                console.log('   4. 浏览器控制台是否有其他错误');
            };
            
            document.head.appendChild(script);
            return true;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 OrientDiscover 应用启动');

            // 先尝试加载配置
            await loadAppConfig();

            // 然后加载Google Maps API
            loadGoogleMapsAPI();
        });
    </script>

    <script src="app.js"></script>
</body>
</html>