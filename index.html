<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹å‘æ¢ç´¢æ´¾å¯¹æ™ºèƒ½å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <h1>ğŸ§­ æ–¹å‘æ¢ç´¢æ´¾å¯¹</h1>
            <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
        </header>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-group">
                <label>ç›®æ ‡è·ç¦»:</label>
                <select id="segmentDistance" onchange="updateSettings()">
                    <option value="5">5km</option>
                    <option value="10" selected>10km</option>
                    <option value="15">15km</option>
                    <option value="20">20km</option>
                </select>
            </div>
            <div class="setting-group">
                <label>æ¨¡å¼:</label>
                <select id="timeMode" onchange="updateSettings()">
                    <option value="present" selected>ç°ä»£æ¨¡å¼</option>
                    <option value="past">å¤ä»£æ¨¡å¼</option>
                </select>
            </div>

            <div class="setting-group">
                <label>é€Ÿåº¦ (km/h):</label>
                <input type="number" id="speed" value="120" min="1" max="1000" onchange="updateSettings()">
            </div>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
        <div class="status-section">
            <!-- é¢„è®¾åœ°å€é€‰æ‹©å™¨ -->
            <div class="preset-location-selector">
                <div class="preset-selector-header">
                    <span class="preset-label">ğŸ“ é€‰æ‹©èµ·å§‹ä½ç½®:</span>
                </div>
                <div class="preset-selector-controls">
                    <select id="presetLocationSelect" onchange="handlePresetLocationChange()">
                        <option value="">ğŸŒ é€‰æ‹©é¢„è®¾åœ°å€...</option>
                        <option value="tokyo">ğŸ¯ ä¸œäº¬ - æµ…è‰å¯ºåŒºåŸŸ</option>
                        <option value="paris">ğŸ—¼ å·´é» - åŸƒè²å°”é“å¡”</option>
                        <option value="newyork">ğŸ—½ çº½çº¦ - æ—¶ä»£å¹¿åœº</option>
                        <option value="london">ğŸ° ä¼¦æ•¦ - å¤§æœ¬é’Ÿ</option>
                        <option value="sydney">ğŸ­ æ‚‰å°¼ - æ­Œå‰§é™¢</option>
                        <option value="sanfrancisco">ğŸŒ‰ æ—§é‡‘å±± - é‡‘é—¨å¤§æ¡¥</option>
                        <option value="rome">ğŸ›ï¸ ç½—é©¬ - æ–—å…½åœº</option>
                        <option value="beijing">ğŸ® åŒ—äº¬ - æ•…å®«</option>
                        <option value="amsterdam">ğŸŒ· é˜¿å§†æ–¯ç‰¹ä¸¹ - è¿æ²³åŒº</option>
                        <option value="current" selected>ğŸ“± ä½¿ç”¨å½“å‰ä½ç½®</option>
                        <option value="manual">âœ‹ æ‰‹åŠ¨è¾“å…¥åæ ‡</option>
                    </select>
                    <button class="quick-switch-btn" onclick="quickSwitchLocation()" title="å¿«é€Ÿåˆ‡æ¢">
                        ğŸ”„
                    </button>
                </div>
            </div>
            
            <!-- å†å²æ¨¡å¼é¢æ¿ -->
            <div class="historical-mode-panel" id="historicalModePanel">
                <div class="historical-header">
                    <span class="historical-label">â° æ—¶å…‰æœºæ¨¡å¼</span>
                    <button class="historical-toggle" id="historicalToggle" onclick="toggleHistoricalMode()">
                        ğŸ•°ï¸ å¯ç”¨å†å²æ¢ç´¢
                    </button>
                </div>
                
                <div class="historical-controls" id="historicalControls" style="display: none;">
                    <div class="time-period-selector">
                        <label>ğŸ“… é€‰æ‹©å†å²æ—¶æœŸ:</label>
                        <select id="historicalPeriod" onchange="updateHistoricalYear()">
                            <option value="">é€‰æ‹©å†å²æ—¶æœŸ...</option>
                            <option value="2000">ç°ä»£ (2000å¹´)</option>
                            <option value="1945">äºŒæˆ˜å (1945å¹´)</option>
                            <option value="1914">ä¸€æˆ˜å‰ (1914å¹´)</option>
                            <option value="1880">å·¥ä¸šé©å‘½ (1880å¹´)</option>
                            <option value="1815">æ‹¿ç ´ä»‘æˆ˜äº‰å (1815å¹´)</option>
                            <option value="1650">å¨æ–¯ç‰¹ä¼åˆ©äºšå’Œçº¦ (1650å¹´)</option>
                            <option value="1600">æ±Ÿæˆ·æ—¶ä»£ (1600å¹´)</option>
                            <option value="1492">å¤§èˆªæµ·æ—¶ä»£ (1492å¹´)</option>
                            <option value="1279">å…ƒæœå»ºç«‹ (1279å¹´)</option>
                            <option value="800">æŸ¥ç†å¤§å¸åŠ å†• (800å¹´)</option>
                            <option value="400">ç½—é©¬å¸å›½åˆ†è£‚ (400å¹´)</option>
                            <option value="-1">å¤å…¸æ—¶æœŸ (å…¬å…ƒå‰1å¹´)</option>
                            <option value="custom">è‡ªå®šä¹‰å¹´ä»½...</option>
                        </select>
                    </div>
                    
                    <div class="custom-year-input" id="customYearDiv" style="display: none;">
                        <label>ğŸ¯ è‡ªå®šä¹‰å¹´ä»½:</label>
                        <input type="number" id="customYearInput" placeholder="è¾“å…¥å¹´ä»½" 
                               min="-3000" max="2024" value="1000">
                        <span class="year-hint">ï¼ˆå…¬å…ƒå‰å¹´ä»½è¯·è¾“å…¥è´Ÿæ•°ï¼‰</span>
                    </div>
                    
                    <div class="historical-info-display" id="historicalInfoDisplay">
                        <div class="selected-year">
                            <span class="label">ğŸ—“ï¸ æ¢ç´¢å¹´ä»½:</span>
                            <span id="selectedYear">æœªé€‰æ‹©</span>
                        </div>
                        <div class="mode-indicator">
                            <span class="label">ğŸ­ æ¨¡å¼:</span>
                            <span id="modeIndicator">æ¼”ç¤ºæ¨¡å¼</span>
                        </div>
                    </div>
                    
                    <button class="time-travel-btn" id="timeTravelBtn" onclick="startHistoricalExploration()" disabled>
                        ğŸš€ å¼€å§‹æ—¶ç©ºæ¢ç´¢
                    </button>
                </div>
            </div>

            <!-- æ—¶å…‰è‡ªæ‹åŠŸèƒ½é¢æ¿ -->
            <div class="historical-selfie-panel" id="historicalSelfiePanel" style="display: none;">
                <div class="selfie-header">
                    <h3>ğŸ“¸ æ—¶å…‰è‡ªæ‹</h3>
                    <p>ä¸å†å²æ—¶åˆ»ç•™ä¸‹æ°¸æ’å›å¿†</p>
                </div>
                
                <!-- è‡ªæ‹è¯¢é—®å¯¹è¯æ¡† -->
                <div class="selfie-question" id="selfieQuestion">
                    <div class="question-content">
                        <!-- ç”¨æˆ·å¤´åƒé¢„è§ˆ -->
                        <div class="user-avatar-preview">
                            <img src="http://localhost:8000/static/profile_photo/profile.jpg" 
                                 alt="æ‚¨çš„å¤´åƒ" 
                                 class="avatar-image" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-placeholder" style="display: none;">
                                ğŸ‘¤
                            </div>
                            <p class="avatar-label">æ‚¨çš„è§’è‰²</p>
                        </div>
                        
                        <div class="selfie-question-text">
                            <p>ğŸ­ æƒ³è¦ä¸è¿™ä¸ªå†å²æ—¶ä»£åˆå½±ç•™å¿µå—ï¼Ÿ</p>
                            <p class="question-subtitle">é€‰æ‹©ä¸€ä¸ªåœºæ™¯ï¼Œç”Ÿæˆä¸“å±çš„æ—¶å…‰è‡ªæ‹ï¼</p>
                        </div>
                        
                        <div class="question-actions">
                            <button class="selfie-yes-btn" onclick="startHistoricalSelfie()">
                                ğŸ“¸ æ˜¯çš„ï¼Œæˆ‘è¦è‡ªæ‹ï¼
                            </button>
                            <button class="selfie-no-btn" onclick="skipSelfie()">
                                âŒ ä¸äº†ï¼Œç›´æ¥æ€»ç»“
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- åœºæ™¯é€‰æ‹©ç•Œé¢ -->
                <div class="selfie-scene-selector" id="selfieSceneSelector" style="display: none;">
                    <h4>ğŸ›ï¸ é€‰æ‹©è‡ªæ‹åœºæ™¯</h4>
                    <div class="visited-scenes" id="visitedScenes">
                        <!-- åŠ¨æ€å¡«å……å·²è®¿é—®çš„åœºæ™¯ -->
                    </div>
                    <div class="selfie-controls">
                        <button class="back-btn" onclick="backToSelfieQuestion()">
                            â† è¿”å›
                        </button>
                    </div>
                </div>
                
                <!-- è‡ªæ‹ç»“æœæ˜¾ç¤º -->
                <div class="selfie-result" id="selfieResult" style="display: none;">
                    <h4>ğŸ¤³ æ‚¨çš„æ—¶å…‰è‡ªæ‹</h4>
                    <div class="selfie-image-container">
                        <img id="selfieImage" alt="æ—¶å…‰è‡ªæ‹" />
                        <div class="selfie-info">
                            <p id="selfieDescription">æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±æ—¶å…‰è‡ªæ‹...</p>
                        </div>
                    </div>
                    <div class="selfie-actions">
                        <button class="share-selfie-btn" onclick="shareSelfie()">
                            ğŸ”— åˆ†äº«è‡ªæ‹
                        </button>
                        <button class="continue-journey-btn" onclick="continueToSummary()">
                            ğŸ“– æŸ¥çœ‹æ—…é€”æ€»ç»“
                        </button>
                    </div>
                </div>
                
                <!-- æ—…é€”æ€»ç»“ -->
                <div class="journey-summary" id="journeySummary" style="display: none;">
                    <h3>ğŸ“– æ—¶å…‰ç©¿è¶Šæ—…é€”æ€»ç»“</h3>
                    <div class="summary-content">
                        <div class="visited-places" id="summaryPlaces">
                            <!-- åŠ¨æ€å¡«å……è®¿é—®çš„åœ°ç‚¹ -->
                        </div>
                        <div class="journey-selfie" id="journeySelfie">
                            <!-- æ˜¾ç¤ºè‡ªæ‹ç…§ç‰‡ -->
                        </div>
                        <div class="journey-text" id="journeyText">
                            <!-- AIç”Ÿæˆçš„æ—…é€”æ€»ç»“æ–‡å­— -->
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="new-journey-btn" onclick="startNewJourney()">
                            ğŸš€ å¼€å§‹æ–°æ—…é€”
                        </button>
                        <button class="share-journey-btn" onclick="shareJourney()">
                            ğŸ”— åˆ†äº«æ—…é€”
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="location-info">
                <div class="current-location">
                    <span class="label">å½“å‰ä½ç½®:</span>
                    <span id="currentLocation">è·å–ä¸­...</span>
                </div>
                <div class="coordinates-info">
                    <span class="label">ç»çº¬åº¦:</span>
                    <span id="coordinates">--Â°, --Â°</span>
                </div>
                <div class="accuracy-info">
                    <span class="label">ç²¾åº¦:</span>
                    <span id="accuracy">--m</span>
                </div>
                <div class="compass-info">
                    <span class="label">æœå‘:</span>
                    <span id="compassDirection">--Â°</span>
                </div>
                <div class="direction-text">
                    <span class="label">æ–¹å‘:</span>
                    <span id="directionText">--</span>
                </div>
            </div>
            
            <!-- æŒ‡å—é’ˆæ˜¾ç¤º -->
            <div class="compass-container">
                <div class="compass" id="compass">
                    <div class="compass-needle" id="compassNeedle">
                        <div class="needle-diamond">
                            <div class="needle-north"></div>
                            <div class="needle-south"></div>
                        </div>
                    </div>
                    <div class="compass-center"></div>
                    <div class="compass-directions">
                        <div class="direction north">N</div>
                        <div class="direction east">E</div>
                        <div class="direction south">S</div>
                        <div class="direction west">W</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="explore-btn" id="exploreBtn" onclick="startExploration()">
                ğŸš€ å¼€å§‹æ¢ç´¢
            </button>
            <button class="refresh-btn" onclick="refreshLocation()">
                ğŸ“ åˆ·æ–°ä½ç½®
            </button>
            <button class="end-journey-btn" id="endJourneyBtn" onclick="endJourney()" style="display: none;">
                ğŸ  ç»“æŸæ—…ç¨‹
            </button>
        </div>

        <!-- å†å²è®¿é—®åœºæ™¯ -->
        <div class="journey-history-section" id="journeyHistorySection" style="display: none;">
            <h3>ğŸ’ å·²è®¿é—®çš„åœ°ç‚¹</h3>
            <div class="history-places-container" id="historyPlacesContainer">
                <!-- å†å²è®¿é—®çš„åœ°ç‚¹å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æ—…ç¨‹æ€»ç»“å®¹å™¨ -->
        <div class="journey-summary-container" id="journeySummaryContainer" style="display: none;">
            <!-- æ—…ç¨‹æ€»ç»“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <!-- åœ°ç‚¹å¡ç‰‡å®¹å™¨ -->
        <div class="places-container" id="placesContainer">
            <!-- åœ°ç‚¹å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨è®¡ç®—è·¯å¾„...</p>
        </div>

        <!-- æ—¥å¿—æ˜¾ç¤ºåŒº -->
        <div class="log-section">
            <div class="log-header">
                <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                <button class="clear-log-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-container" id="logContainer">
                <!-- æ—¥å¿—ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- Googleè¡—æ™¯æ¨¡æ€æ¡† -->
        <div class="streetview-modal" id="streetviewModal" style="display: none;">
            <div class="streetview-modal-content">
                <div class="streetview-header">
                    <h3 id="streetviewTitle">ğŸ™ï¸ è¡—æ™¯è§†å›¾</h3>
                    <button class="close-streetview-btn" onclick="closeStreetView()">âœ•</button>
                </div>
                <div class="streetview-controls">
                    <button class="streetview-control-btn" onclick="resetStreetViewHeading()" title="é‡ç½®æœå‘">
                        ğŸ§­ é‡ç½®è§†è§’
                    </button>
                    <button class="streetview-control-btn" onclick="toggleStreetViewFullscreen()" title="å…¨å±">
                        ğŸ” å…¨å±
                    </button>
                    <button class="streetview-control-btn" onclick="shareStreetView()" title="åˆ†äº«ä½ç½®">
                        ğŸ“¤ åˆ†äº«
                    </button>
                </div>
                <div class="streetview-container" id="streetviewContainer">
                    <div class="streetview-loading" id="streetviewLoading">
                        <div class="streetview-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è¡—æ™¯...</p>
                    </div>
                    <div class="streetview-error" id="streetviewError" style="display: none;">
                        <div class="error-icon">ğŸš«</div>
                        <h4>è¡—æ™¯ä¸å¯ç”¨</h4>
                        <p id="streetviewErrorText">è¯¥ä½ç½®æš‚æ—¶æ²¡æœ‰è¡—æ™¯æ•°æ®</p>
                        <button class="retry-streetview-btn" onclick="retryStreetView()">é‡è¯•</button>
                    </div>
                </div>
                <div class="streetview-info" id="streetviewInfo">
                    <div class="streetview-location">
                        <span class="info-label">ğŸ“ ä½ç½®:</span>
                        <span id="streetviewLocation">--</span>
                    </div>
                    <div class="streetview-coordinates">
                        <span class="info-label">ğŸ“Š åæ ‡:</span>
                        <span id="streetviewCoords">--</span>
                    </div>
                    <div class="streetview-date">
                        <span class="info-label">ğŸ“… æ‹æ‘„æ—¶é—´:</span>
                        <span id="streetviewDate">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Googleè¡—æ™¯é®ç½©å±‚ -->
        <div class="streetview-overlay" id="streetviewOverlay" style="display: none;" onclick="closeStreetView()"></div>
    </div>

    <!-- Google Maps JavaScript API é…ç½® -->
    <script>
        // åº”ç”¨é…ç½® - API Keyé…ç½®åœ¨ç¯å¢ƒå˜é‡ä¸­
        window.appConfig = {
            // æ³¨æ„ï¼šå®é™…éƒ¨ç½²æ—¶åº”ä»åç«¯æˆ–ç¯å¢ƒå˜é‡è·å–æ­¤å€¼
            // ä¸è¦å°†çœŸå®çš„API Keyæäº¤åˆ°ä»£ç åº“ï¼
            // å¼€å‘æ—¶è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® GOOGLE_MAPS_API_KEY
            googleMapsApiKey: 'YOUR_GOOGLE_MAPS_API_KEY', // å°†è¢«åŠ¨æ€æ›¿æ¢
            useLangchain: true
        };

        // å°è¯•ä»åç«¯è·å–APIé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
        async function loadAppConfig() {
            try {
                const response = await fetch('http://localhost:8000/api/config/maps');
                if (response.ok) {
                    const config = await response.json();
                    window.appConfig.googleMapsApiKey = config.apiKey;
                    console.log('âœ… ä»åç«¯è·å–åˆ°APIé…ç½®');
                }
            } catch (error) {
                console.log('âš ï¸ æ— æ³•ä»åç«¯è·å–APIé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            }
        }

        // æ·»åŠ å…¨å±€çŠ¶æ€å˜é‡
        window.googleMapsLoadStatus = 'pending'; // pending, loading, loaded, failed

        // Google Maps API å›è°ƒå‡½æ•°
        window.initGoogleMaps = function() {
            console.log('âœ… Google Maps API å·²åŠ è½½');
            console.log('ğŸ™ï¸ Street View æœåŠ¡å·²å‡†å¤‡å°±ç»ª');
            window.googleMapsLoadStatus = 'loaded';

            // åˆå§‹åŒ–è¡—æ™¯ç›¸å…³å˜é‡
            if (typeof initGoogleMapsAPI === 'function') {
                initGoogleMapsAPI();
            }
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥APIå·²åŠ è½½
            window.dispatchEvent(new Event('googleMapsLoaded'));
        };

        // åŠ¨æ€åŠ è½½Google Maps API
        function loadGoogleMapsAPI() {
            const apiKey = window.appConfig.googleMapsApiKey;
            
            console.log('ğŸ” å¼€å§‹åŠ è½½Google Maps API');
            console.log('   API Key:', apiKey ? apiKey.substring(0, 10) + '...' : 'æœªè®¾ç½®');

            if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.warn('âš ï¸ Google Maps API Key æœªé…ç½®');
                window.googleMapsLoadStatus = 'failed';
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²å­˜åœ¨');
                window.googleMapsLoadStatus = 'loaded';
                window.initGoogleMaps();
                return true;
            }

            window.googleMapsLoadStatus = 'loading';
            console.log('ğŸ”„ æ­£åœ¨åŠ è½½ Google Maps API...');
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGoogleMaps&v=weekly&libraries=geometry`;
            script.async = true;
            script.defer = true;
            
            script.onload = function() {
                console.log('âœ… Google Maps scriptæ ‡ç­¾åŠ è½½å®Œæˆ');
            };
            
            script.onerror = function(error) {
                window.googleMapsLoadStatus = 'failed';
                console.error('âŒ Google Maps API åŠ è½½å¤±è´¥');
                console.log('ğŸ” è¯·æ£€æŸ¥:');
                console.log('   1. API Key æ˜¯å¦æ­£ç¡®');
                console.log('   2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                console.log('   3. API Key æ˜¯å¦æœ‰æ­£ç¡®çš„æƒé™');
                console.log('   4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯');
            };
            
            document.head.appendChild(script);
            return true;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ OrientDiscover åº”ç”¨å¯åŠ¨');

            // å…ˆå°è¯•åŠ è½½é…ç½®
            await loadAppConfig();

            // ç„¶ååŠ è½½Google Maps API
            loadGoogleMapsAPI();
        });
    </script>

    <script src="app.js"></script>
</body>
</html>