<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹å‘æ¢ç´¢æ´¾å¯¹æ™ºèƒ½å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <h1>ğŸ§­ æ–¹å‘æ¢ç´¢æ´¾å¯¹</h1>
            <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
        </header>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-group">
                <label>ç›®æ ‡è·ç¦»:</label>
                <select id="segmentDistance" onchange="updateSettings()">
                    <option value="5">5km</option>
                    <option value="10" selected>10km</option>
                    <option value="15">15km</option>
                    <option value="20">20km</option>
                </select>
            </div>
            <div class="setting-group">
                <label>æ¨¡å¼:</label>
                <select id="timeMode" onchange="updateSettings()">
                    <option value="present" selected>ç°ä»£æ¨¡å¼</option>
                    <option value="past">å¤ä»£æ¨¡å¼</option>
                </select>
            </div>

            <div class="setting-group">
                <label>é€Ÿåº¦ (km/h):</label>
                <input type="number" id="speed" value="120" min="1" max="1000" onchange="updateSettings()">
            </div>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
        <div class="status-section">
            <div class="location-info">
                <div class="current-location">
                    <span class="label">å½“å‰ä½ç½®:</span>
                    <span id="currentLocation">è·å–ä¸­...</span>
                </div>
                <div class="coordinates-info">
                    <span class="label">ç»çº¬åº¦:</span>
                    <span id="coordinates">--Â°, --Â°</span>
                </div>
                <div class="accuracy-info">
                    <span class="label">ç²¾åº¦:</span>
                    <span id="accuracy">--m</span>
                </div>
                <div class="compass-info">
                    <span class="label">æœå‘:</span>
                    <span id="compassDirection">--Â°</span>
                </div>
                <div class="direction-text">
                    <span class="label">æ–¹å‘:</span>
                    <span id="directionText">--</span>
                </div>
            </div>
            
            <!-- æŒ‡å—é’ˆæ˜¾ç¤º -->
            <div class="compass-container">
                <div class="compass" id="compass">
                    <div class="compass-needle" id="compassNeedle">
                        <div class="needle-diamond">
                            <div class="needle-north"></div>
                            <div class="needle-south"></div>
                        </div>
                    </div>
                    <div class="compass-center"></div>
                    <div class="compass-directions">
                        <div class="direction north">N</div>
                        <div class="direction east">E</div>
                        <div class="direction south">S</div>
                        <div class="direction west">W</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="explore-btn" id="exploreBtn" onclick="startExploration()">
                ğŸš€ å¼€å§‹æ¢ç´¢
            </button>
            <button class="refresh-btn" onclick="refreshLocation()">
                ğŸ“ åˆ·æ–°ä½ç½®
            </button>
            <button class="end-journey-btn" id="endJourneyBtn" onclick="endJourney()" style="display: none;">
                ğŸ  ç»“æŸæ—…ç¨‹
            </button>
        </div>

        <!-- å†å²è®¿é—®åœºæ™¯ -->
        <div class="journey-history-section" id="journeyHistorySection" style="display: none;">
            <h3>ğŸ’ å·²è®¿é—®çš„åœ°ç‚¹</h3>
            <div class="history-places-container" id="historyPlacesContainer">
                <!-- å†å²è®¿é—®çš„åœ°ç‚¹å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- åœ°ç‚¹å¡ç‰‡å®¹å™¨ -->
        <div class="places-container" id="placesContainer">
            <!-- åœ°ç‚¹å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨è®¡ç®—è·¯å¾„...</p>
        </div>

        <!-- æ—¥å¿—æ˜¾ç¤ºåŒº -->
        <div class="log-section">
            <div class="log-header">
                <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                <button class="clear-log-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-container" id="logContainer">
                <!-- æ—¥å¿—ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- Googleè¡—æ™¯æ¨¡æ€æ¡† -->
        <div class="streetview-modal" id="streetviewModal" style="display: none;">
            <div class="streetview-modal-content">
                <div class="streetview-header">
                    <h3 id="streetviewTitle">ğŸ™ï¸ è¡—æ™¯è§†å›¾</h3>
                    <button class="close-streetview-btn" onclick="closeStreetView()">âœ•</button>
                </div>
                <div class="streetview-controls">
                    <button class="streetview-control-btn" onclick="resetStreetViewHeading()" title="é‡ç½®æœå‘">
                        ğŸ§­ é‡ç½®è§†è§’
                    </button>
                    <button class="streetview-control-btn" onclick="toggleStreetViewFullscreen()" title="å…¨å±">
                        ğŸ” å…¨å±
                    </button>
                    <button class="streetview-control-btn" onclick="shareStreetView()" title="åˆ†äº«ä½ç½®">
                        ğŸ“¤ åˆ†äº«
                    </button>
                </div>
                <div class="streetview-container" id="streetviewContainer">
                    <div class="streetview-loading" id="streetviewLoading">
                        <div class="streetview-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è¡—æ™¯...</p>
                    </div>
                    <div class="streetview-error" id="streetviewError" style="display: none;">
                        <div class="error-icon">ğŸš«</div>
                        <h4>è¡—æ™¯ä¸å¯ç”¨</h4>
                        <p id="streetviewErrorText">è¯¥ä½ç½®æš‚æ—¶æ²¡æœ‰è¡—æ™¯æ•°æ®</p>
                        <button class="retry-streetview-btn" onclick="retryStreetView()">é‡è¯•</button>
                    </div>
                </div>
                <div class="streetview-info" id="streetviewInfo">
                    <div class="streetview-location">
                        <span class="info-label">ğŸ“ ä½ç½®:</span>
                        <span id="streetviewLocation">--</span>
                    </div>
                    <div class="streetview-coordinates">
                        <span class="info-label">ğŸ“Š åæ ‡:</span>
                        <span id="streetviewCoords">--</span>
                    </div>
                    <div class="streetview-date">
                        <span class="info-label">ğŸ“… æ‹æ‘„æ—¶é—´:</span>
                        <span id="streetviewDate">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Googleè¡—æ™¯é®ç½©å±‚ -->
        <div class="streetview-overlay" id="streetviewOverlay" style="display: none;" onclick="closeStreetView()"></div>
    </div>

    <!-- Google Maps JavaScript API é…ç½® -->
    <script>
        // åº”ç”¨é…ç½® - API Keyé…ç½®åœ¨ç¯å¢ƒå˜é‡ä¸­
        window.appConfig = {
            // æ³¨æ„ï¼šå®é™…éƒ¨ç½²æ—¶åº”ä»åç«¯æˆ–ç¯å¢ƒå˜é‡è·å–æ­¤å€¼
            // ä¸è¦å°†çœŸå®çš„API Keyæäº¤åˆ°ä»£ç åº“ï¼
            // å¼€å‘æ—¶è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® GOOGLE_MAPS_API_KEY
            googleMapsApiKey: 'YOUR_GOOGLE_MAPS_API_KEY', // å°†è¢«åŠ¨æ€æ›¿æ¢
            useLangchain: true
        };

        // å°è¯•ä»åç«¯è·å–APIé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
        async function loadAppConfig() {
            try {
                const response = await fetch('/api/config/maps');
                if (response.ok) {
                    const config = await response.json();
                    window.appConfig.googleMapsApiKey = config.apiKey;
                    console.log('âœ… ä»åç«¯è·å–åˆ°APIé…ç½®');
                }
            } catch (error) {
                console.log('âš ï¸ æ— æ³•ä»åç«¯è·å–APIé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            }
        }

        // Google Maps API å›è°ƒå‡½æ•°
        window.initGoogleMaps = function() {
            console.log('âœ… Google Maps API å·²åŠ è½½');
            console.log('ğŸ™ï¸ Street View æœåŠ¡å·²å‡†å¤‡å°±ç»ª');

            // åˆå§‹åŒ–è¡—æ™¯ç›¸å…³å˜é‡
            if (typeof initGoogleMapsAPI === 'function') {
                initGoogleMapsAPI();
            }
        };

        // åŠ¨æ€åŠ è½½Google Maps API
        function loadGoogleMapsAPI() {
            const apiKey = window.appConfig.googleMapsApiKey;

            if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.warn('âš ï¸ Google Maps API Key æœªé…ç½®ï¼Œè¯·åœ¨ appConfig ä¸­è®¾ç½®æœ‰æ•ˆçš„API Key');
                console.log('ğŸ’¡ å½“å‰é…ç½®çš„API Key:', apiKey);
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²å­˜åœ¨ï¼Œè·³è¿‡é‡æ–°åŠ è½½');
                window.initGoogleMaps();
                return true;
            }

            console.log('ğŸ”„ æ­£åœ¨åŠ è½½ Google Maps API...');
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGoogleMaps&v=weekly&libraries=geometry`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                console.error('âŒ Google Maps API åŠ è½½å¤±è´¥');
                console.log('ğŸ” è¯·æ£€æŸ¥:');
                console.log('   1. API Key æ˜¯å¦æ­£ç¡®');
                console.log('   2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                console.log('   3. API Key æ˜¯å¦æœ‰æ­£ç¡®çš„æƒé™');
            };
            document.head.appendChild(script);
            return true;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ OrientDiscover åº”ç”¨å¯åŠ¨');

            // å…ˆå°è¯•åŠ è½½é…ç½®
            await loadAppConfig();

            // ç„¶ååŠ è½½Google Maps API
            loadGoogleMapsAPI();
        });
    </script>

    <script src="app.js"></script>
</body>
</html>