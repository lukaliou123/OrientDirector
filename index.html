<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方向探索派对智能工具</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- 头部导航 -->
        <header class="header">
            <h1>🧭 方向探索派对</h1>
            <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
        </header>

        <!-- 设置面板 -->
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-group">
                <label>目标距离:</label>
                <select id="segmentDistance" onchange="updateSettings()">
                    <option value="5">5km</option>
                    <option value="10" selected>10km</option>
                    <option value="15">15km</option>
                    <option value="20">20km</option>
                </select>
            </div>
            <div class="setting-group">
                <label>模式:</label>
                <select id="timeMode" onchange="updateSettings()">
                    <option value="present" selected>现代模式</option>
                    <option value="past">古代模式</option>
                </select>
            </div>

            <div class="setting-group">
                <label>速度 (km/h):</label>
                <input type="number" id="speed" value="120" min="1" max="1000" onchange="updateSettings()">
            </div>
        </div>

        <!-- 状态显示区 -->
        <div class="status-section">
            <!-- 预设地址选择器 -->
            <div class="preset-location-selector">
                <div class="preset-selector-header">
                    <span class="preset-label">📍 选择起始位置:</span>
                </div>
                <div class="preset-selector-controls">
                    <select id="presetLocationSelect" onchange="handlePresetLocationChange()">
                        <option value="">🌍 选择预设地址...</option>
                        <option value="tokyo">🏯 东京 - 浅草寺区域</option>
                        <option value="paris">🗼 巴黎 - 埃菲尔铁塔</option>
                        <option value="newyork">🗽 纽约 - 时代广场</option>
                        <option value="london">🏰 伦敦 - 大本钟</option>
                        <option value="sydney">🎭 悉尼 - 歌剧院</option>
                        <option value="sanfrancisco">🌉 旧金山 - 金门大桥</option>
                        <option value="rome">🏛️ 罗马 - 斗兽场</option>
                        <option value="beijing">🏮 北京 - 故宫</option>
                        <option value="amsterdam">🌷 阿姆斯特丹 - 运河区</option>
                        <option value="current" selected>📱 使用当前位置</option>
                        <option value="manual">✋ 手动输入坐标</option>
                    </select>
                    <button class="quick-switch-btn" onclick="quickSwitchLocation()" title="快速切换">
                        🔄
                    </button>
                </div>
            </div>
            
            <!-- 历史模式面板 -->
            <div class="historical-mode-panel" id="historicalModePanel">
                <div class="historical-header">
                    <span class="historical-label">⏰ 时光机模式</span>
                    <button class="historical-toggle" id="historicalToggle" onclick="toggleHistoricalMode()">
                        🕰️ 启用历史探索
                    </button>
                </div>
                
                <div class="historical-controls" id="historicalControls" style="display: none;">
                    <div class="time-period-selector">
                        <label>📅 选择历史时期:</label>
                        <select id="historicalPeriod" onchange="updateHistoricalYear()">
                            <option value="">选择历史时期...</option>
                            <option value="2000">现代 (2000年)</option>
                            <option value="1945">二战后 (1945年)</option>
                            <option value="1914">一战前 (1914年)</option>
                            <option value="1880">工业革命 (1880年)</option>
                            <option value="1815">拿破仑战争后 (1815年)</option>
                            <option value="1650">威斯特伐利亚和约 (1650年)</option>
                            <option value="1600">江户时代 (1600年)</option>
                            <option value="1492">大航海时代 (1492年)</option>
                            <option value="1279">元朝建立 (1279年)</option>
                            <option value="800">查理大帝加冕 (800年)</option>
                            <option value="400">罗马帝国分裂 (400年)</option>
                            <option value="-1">古典时期 (公元前1年)</option>
                            <option value="custom">自定义年份...</option>
                        </select>
                    </div>
                    
                    <div class="custom-year-input" id="customYearDiv" style="display: none;">
                        <label>🎯 自定义年份:</label>
                        <input type="number" id="customYearInput" placeholder="输入年份" 
                               min="-3000" max="2024" value="1000">
                        <span class="year-hint">（公元前年份请输入负数）</span>
                    </div>
                    
                    <div class="historical-info-display" id="historicalInfoDisplay">
                        <div class="selected-year">
                            <span class="label">🗓️ 探索年份:</span>
                            <span id="selectedYear">未选择</span>
                        </div>
                        <div class="mode-indicator">
                            <span class="label">🎭 模式:</span>
                            <span id="modeIndicator">演示模式</span>
                        </div>
                    </div>
                    
                    <button class="time-travel-btn" id="timeTravelBtn" onclick="startHistoricalExploration()" disabled>
                        🚀 开始时空探索
                    </button>
                </div>
            </div>

            <!-- 时光自拍功能面板 -->
            <div class="historical-selfie-panel" id="historicalSelfiePanel" style="display: none;">
                <div class="selfie-header">
                    <h3>📸 时光自拍</h3>
                    <p>与历史时刻留下永恒回忆</p>
                </div>
                
                <!-- 自拍询问对话框 -->
                <div class="selfie-question" id="selfieQuestion">
                    <div class="question-content">
                        <!-- 用户头像预览 -->
                        <div class="user-avatar-preview">
                            <img src="http://localhost:8000/static/profile_photo/profile.jpg" 
                                 alt="您的头像" 
                                 class="avatar-image" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-placeholder" style="display: none;">
                                👤
                            </div>
                            <p class="avatar-label">您的角色</p>
                        </div>
                        
                        <div class="selfie-question-text">
                            <p>🎭 想要与这个历史时代合影留念吗？</p>
                            <p class="question-subtitle">选择一个场景，生成专属的时光自拍！</p>
                        </div>
                        
                        <div class="question-actions">
                            <button class="selfie-yes-btn" onclick="startHistoricalSelfie()">
                                📸 是的，我要自拍！
                            </button>
                            <button class="selfie-no-btn" onclick="skipSelfie()">
                                ❌ 不了，直接总结
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 场景选择界面 -->
                <div class="selfie-scene-selector" id="selfieSceneSelector" style="display: none;">
                    <h4>🏛️ 选择自拍场景</h4>
                    <div class="visited-scenes" id="visitedScenes">
                        <!-- 动态填充已访问的场景 -->
                    </div>
                    <div class="selfie-controls">
                        <button class="back-btn" onclick="backToSelfieQuestion()">
                            ← 返回
                        </button>
                    </div>
                </div>
                
                <!-- 自拍结果显示 -->
                <div class="selfie-result" id="selfieResult" style="display: none;">
                    <h4>🤳 您的时光自拍</h4>
                    <div class="selfie-image-container">
                        <img id="selfieImage" alt="时光自拍" />
                        <div class="selfie-info">
                            <p id="selfieDescription">正在生成您的专属时光自拍...</p>
                        </div>
                    </div>
                    <div class="selfie-actions">
                        <button class="share-selfie-btn" onclick="shareSelfie()">
                            🔗 分享自拍
                        </button>
                        <button class="continue-journey-btn" onclick="continueToSummary()">
                            📖 查看旅途总结
                        </button>
                    </div>
                </div>
                
                <!-- 旅途总结 -->
                <div class="journey-summary" id="journeySummary" style="display: none;">
                    <h3>📖 时光穿越旅途总结</h3>
                    <div class="summary-content">
                        <div class="visited-places" id="summaryPlaces">
                            <!-- 动态填充访问的地点 -->
                        </div>
                        <div class="journey-selfie" id="journeySelfie">
                            <!-- 显示自拍照片 -->
                        </div>
                        <div class="journey-text" id="journeyText">
                            <!-- AI生成的旅途总结文字 -->
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="new-journey-btn" onclick="startNewJourney()">
                            🚀 开始新旅途
                        </button>
                        <button class="share-journey-btn" onclick="shareJourney()">
                            🔗 分享旅途
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="location-info">
                <div class="current-location">
                    <span class="label">当前位置:</span>
                    <span id="currentLocation">获取中...</span>
                </div>
                <div class="coordinates-info">
                    <span class="label">经纬度:</span>
                    <span id="coordinates">--°, --°</span>
                </div>
                <div class="accuracy-info">
                    <span class="label">精度:</span>
                    <span id="accuracy">--m</span>
                </div>
                <div class="compass-info">
                    <span class="label">朝向:</span>
                    <span id="compassDirection">--°</span>
                </div>
                <div class="direction-text">
                    <span class="label">方向:</span>
                    <span id="directionText">--</span>
                </div>
            </div>
            
            <!-- 指南针显示 -->
            <div class="compass-container">
                <div class="compass" id="compass">
                    <div class="compass-needle" id="compassNeedle">
                        <div class="needle-diamond">
                            <div class="needle-north"></div>
                            <div class="needle-south"></div>
                        </div>
                    </div>
                    <div class="compass-center"></div>
                    <div class="compass-directions">
                        <div class="direction north">N</div>
                        <div class="direction east">E</div>
                        <div class="direction south">S</div>
                        <div class="direction west">W</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="controls">
            <button class="explore-btn" id="exploreBtn" onclick="startExploration()">
                🚀 开始探索
            </button>
            <button class="refresh-btn" onclick="refreshLocation()">
                📍 刷新位置
            </button>
            <button class="end-journey-btn" id="endJourneyBtn" onclick="endJourney()" style="display: none;">
                🏠 结束旅程
            </button>
        </div>

        <!-- 历史访问场景 -->
        <div class="journey-history-section" id="journeyHistorySection" style="display: none;">
            <h3>🎒 已访问的地点</h3>
            <div class="history-places-container" id="historyPlacesContainer">
                <!-- 历史访问的地点卡片将在这里显示 -->
            </div>
        </div>

        <!-- 旅程总结容器 -->
        <div class="journey-summary-container" id="journeySummaryContainer" style="display: none;">
            <!-- 旅程总结将在这里显示 -->
        </div>

        <!-- 地点卡片容器 -->
        <div class="places-container" id="placesContainer">
            <!-- 地点卡片将在这里动态生成 -->
        </div>

        <!-- 加载指示器 -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>正在计算路径...</p>
        </div>

        <!-- 日志显示区 -->
        <div class="log-section">
            <div class="log-header">
                <h3>系统日志</h3>
                <button class="clear-log-btn" onclick="clearLogs()">清空日志</button>
            </div>
            <div class="log-container" id="logContainer">
                <!-- 日志信息将在这里显示 -->
            </div>
        </div>

        <!-- Google街景模态框 -->
        <div class="streetview-modal" id="streetviewModal" style="display: none;">
            <div class="streetview-modal-content">
                <div class="streetview-header">
                    <h3 id="streetviewTitle">🏙️ 街景视图</h3>
                    <button class="close-streetview-btn" onclick="closeStreetView()">✕</button>
                </div>
                <div class="streetview-controls">
                    <button class="streetview-control-btn" onclick="resetStreetViewHeading()" title="重置朝向">
                        🧭 重置视角
                    </button>
                    <button class="streetview-control-btn" onclick="toggleStreetViewFullscreen()" title="全屏">
                        🔍 全屏
                    </button>
                    <button class="streetview-control-btn" onclick="shareStreetView()" title="分享位置">
                        📤 分享
                    </button>
                </div>
                <div class="streetview-container" id="streetviewContainer">
                    <div class="streetview-loading" id="streetviewLoading">
                        <div class="streetview-spinner"></div>
                        <p>正在加载街景...</p>
                    </div>
                    <div class="streetview-error" id="streetviewError" style="display: none;">
                        <div class="error-icon">🚫</div>
                        <h4>街景不可用</h4>
                        <p id="streetviewErrorText">该位置暂时没有街景数据</p>
                        <button class="retry-streetview-btn" onclick="retryStreetView()">重试</button>
                    </div>
                </div>
                <div class="streetview-info" id="streetviewInfo">
                    <div class="streetview-location">
                        <span class="info-label">📍 位置:</span>
                        <span id="streetviewLocation">--</span>
                    </div>
                    <div class="streetview-coordinates">
                        <span class="info-label">📊 坐标:</span>
                        <span id="streetviewCoords">--</span>
                    </div>
                    <div class="streetview-date">
                        <span class="info-label">📅 拍摄时间:</span>
                        <span id="streetviewDate">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google街景遮罩层 -->
        <div class="streetview-overlay" id="streetviewOverlay" style="display: none;" onclick="closeStreetView()"></div>
    </div>

    <!-- Google Maps JavaScript API 配置 -->
    <script>
        // 应用配置 - API Key配置在环境变量中
        window.appConfig = {
            // 注意：实际部署时应从后端或环境变量获取此值
            // 不要将真实的API Key提交到代码库！
            // 开发时请在 .env 文件中设置 GOOGLE_MAPS_API_KEY
            googleMapsApiKey: 'YOUR_GOOGLE_MAPS_API_KEY', // 将被动态替换
            useLangchain: true
        };

        // 尝试从后端获取API配置（生产环境推荐）
        async function loadAppConfig() {
            try {
                const response = await fetch('http://localhost:8000/api/config/maps');
                if (response.ok) {
                    const config = await response.json();
                    window.appConfig.googleMapsApiKey = config.apiKey;
                    console.log('✅ 从后端获取到API配置');
                }
            } catch (error) {
                console.log('⚠️ 无法从后端获取API配置，使用默认配置');
            }
        }

        // 添加全局状态变量
        window.googleMapsLoadStatus = 'pending'; // pending, loading, loaded, failed

        // Google Maps API 回调函数
        window.initGoogleMaps = function() {
            console.log('✅ Google Maps API 已加载');
            console.log('🏙️ Street View 服务已准备就绪');
            window.googleMapsLoadStatus = 'loaded';

            // 初始化街景相关变量
            if (typeof initGoogleMapsAPI === 'function') {
                initGoogleMapsAPI();
            }
            
            // 触发自定义事件，通知API已加载
            window.dispatchEvent(new Event('googleMapsLoaded'));
        };

        // 动态加载Google Maps API
        function loadGoogleMapsAPI() {
            const apiKey = window.appConfig.googleMapsApiKey;
            
            console.log('🔍 开始加载Google Maps API');
            console.log('   API Key:', apiKey ? apiKey.substring(0, 10) + '...' : '未设置');

            if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.warn('⚠️ Google Maps API Key 未配置');
                window.googleMapsLoadStatus = 'failed';
                return false;
            }

            // 检查是否已经加载过
            if (window.google && window.google.maps) {
                console.log('✅ Google Maps API 已存在');
                window.googleMapsLoadStatus = 'loaded';
                window.initGoogleMaps();
                return true;
            }

            window.googleMapsLoadStatus = 'loading';
            console.log('🔄 正在加载 Google Maps API...');
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGoogleMaps&v=weekly&libraries=geometry`;
            script.async = true;
            script.defer = true;
            
            script.onload = function() {
                console.log('✅ Google Maps script标签加载完成');
            };
            
            script.onerror = function(error) {
                window.googleMapsLoadStatus = 'failed';
                console.error('❌ Google Maps API 加载失败');
                console.log('🔍 请检查:');
                console.log('   1. API Key 是否正确');
                console.log('   2. 网络连接是否正常');
                console.log('   3. API Key 是否有正确的权限');
                console.log('   4. 浏览器控制台是否有其他错误');
            };
            
            document.head.appendChild(script);
            return true;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 OrientDiscover 应用启动');

            // 先尝试加载配置
            await loadAppConfig();

            // 然后加载Google Maps API
            loadGoogleMapsAPI();
        });
    </script>

    <script src="app.js"></script>
</body>
</html>